	CHIP	65C02

	INCLUDE	"C:\NUVOTON\NSPPLAYLISTEDITOR\V1.13.000\NSP_SDS\SDS_NSP\INCLUDE\PGM_HEAD.INI.APP"

PIN_BP00	EQU  00H
PIN_BP01	EQU  01H
PIN_BP02	EQU  02H
PIN_BP03	EQU  03H
PIN_BP04	EQU  04H
PIN_BP05	EQU  05H
PIN_BP06	EQU  06H
PIN_BP07	EQU  07H

PIN_BP10	EQU  10H
PIN_BP11	EQU  11H
PIN_BP12	EQU  12H
PIN_BP13	EQU  13H
PIN_BP14	EQU  14H
PIN_BP15	EQU  15H
PIN_BP16	EQU  16H
PIN_BP17	EQU  17H

PIN_BP20	EQU  20H
PIN_BP21	EQU  21H
PIN_BP22	EQU  22H
PIN_BP23	EQU  23H
PIN_BP24	EQU  24H
PIN_BP25	EQU  25H
PIN_BP26	EQU  26H
PIN_BP27	EQU  27H	
	INCLUDE	"D:\SOURCECODE\_AVERY_M031\M031BSP_NSP_TWOWIRESAMPLE\NSP_PROJECT\RINGRING_NSP960B\CPUIF\PROJECTSETTING.INI.APP"
	EXTERN		_@SIL_EQU
	EXTERN		_ISPSWAPPINGPAGE_
	EXTERN		_TABLE.BIN

	EXTERN		RESERVE1_ISR
	EXTERN		RESERVE2_ISR
	PUBLIC		INIT
	PUBLIC		PREPARE_FOR_CAP_SLEEP_SETTING

.ifdef	FW_PWM_TIMER_FXF10
	EXTERN		FW_PWM_TIMER_DOWNCOUNT
	PUBLIC		FW_TIMER_DWONCOUNT_RET
.endif
.ifdef	FW_PWM_TIMER_TMA
	EXTERN		FW_PWM_TIMER_DOWNCOUNT
	PUBLIC		FW_TIMER_DWONCOUNT_RET
.endif
.ifdef	FW_PWM_TIMER_TMG
	EXTERN		FW_PWM_TIMER_DOWNCOUNT
	PUBLIC		FW_TIMER_DWONCOUNT_RET
.endif

.ifdef	COLOR_FLY_TIMER_FXF10
	EXTERN		COLOR_FLY_TIMER_DOWNCOUNT
	PUBLIC		COLOR_FLY_DWONCOUNT_RET
.endif
.ifdef	COLOR_FLY_TIMER_TMA
	EXTERN		COLOR_FLY_TIMER_DOWNCOUNT
	PUBLIC		COLOR_FLY_DWONCOUNT_RET
.endif
.ifdef	COLOR_FLY_TIMER_TMG
	EXTERN		COLOR_FLY_TIMER_DOWNCOUNT
	PUBLIC		COLOR_FLY_DWONCOUNT_RET
.endif

;==========================================================================
; Initial For Main.asm Macro
;--------------------------------------------------------------------------
LDA_DP_ILI MACRO VAR_ADDR
	LDA (<VAR_ADDR)
	ENDM

INC_ADDR_DP	MACRO VAR_ADDR
	INC <VAR_ADDR
	BNE INC_ADDR_END_#
	INC <VAR_ADDR+1
	BNE INC_ADDR_END_#
	INC <VAR_ADDR+2
INC_ADDR_END_#:
	ENDM

ADC_ADDR_DP	MACRO VAR_ADDR1,ADC_NUM,VAR_ADDR2
	CLC
	LDA <VAR_ADDR1
	ADC #ADC_NUM
	STA <VAR_ADDR2
	LDA <VAR_ADDR1+1
	ADC #00H
	STA <VAR_ADDR2+1
	LDA <VAR_ADDR1+2
	ADC #00H
	STA <VAR_ADDR2+2
	ENDM
;-------------------------------------------	
INIT_PA	MACRO
;BP06/BP16 ouput 0
.IFDEF EXT_PA
	LDA #PA_OUT_PORT_BIT
	TSB !PA_OUT_PORT_M
	TRB !PA_OUT_PORT_D
	TRB !PA_OUT_PORT		
.ENDIF		
	ENDM

OPEN_PA	MACRO
;BP06/BP16 ouput 1
.IFDEF EXT_PA
	LDA #PA_OUT_PORT_BIT
	TSB !PA_OUT_PORT		
.ENDIF		
	ENDM

CLOSE_PA MACRO
;BP06/BP16 ouput 0
.IFDEF EXT_PA
	LDA #PA_OUT_PORT_BIT
	TRB !PA_OUT_PORT
.ENDIF
	ENDM
;-------------------------------------------
REFRESH_SCLK MACRO	
	LDA !SCLK_PORT
	AND #SCLK_PORT_BIT
	STA <SCLK_PREV
	ENDM

REFRESH_SDA MACRO	
	LDA !SDA_PORT
	AND #SDA_PORT_BIT
	STA <SDA_PREV
	ENDM

REFRESH_SCLK_SDA MACRO
	REFRESH_SCLK
	REFRESH_SDA
	ENDM

RESET_SCLK_SDA MACRO
	LDA #SCLK_PORT_BIT
	STA <SCLK_PREV
	LDA #SDA_PORT_BIT
	STA <SDA_PREV
	ENDM
;-------------------------------------------			
CLEAR_RX_RAM MACRO	
	STZ <RX_DATA
	STZ <RX_DATA+1
	STZ <RX_DATA+2
	STZ <RX_DATA+3
	STZ <RX_DATA+4
	STZ <RX_DATA+5
	STZ <RX_DATA+6
	STZ <RX_DATA+7
	STZ <RX_BYTE_INDEX
	LDA #08H
	STA <RX_BIT_INDEX
	STZ <RX_BYTE_COUNTER
	STZ <RX_DATA_CMD
	STZ <RX_CHKSUM
	ENDM

CLEAR_TX_RAM MACRO	
	STZ <TX_DATA
	STZ <TX_DATA+1
	STZ <TX_DATA+2
	STZ <TX_DATA+3
	STZ <TX_DATA+4
	STZ <TX_DATA+5
	STZ <TX_DATA+6
	STZ <TX_DATA+7
	STZ <TX_DATA+8
	STZ <TX_DATA+9
	STZ <TX_DATA+10
	STZ <TX_DATA+11
	STZ <TX_DATA+12
	STZ <TX_DATA+13
	STZ <TX_BYTE_INDEX
;STZ <TX_BIT_INDEX
	STZ <TX_BYTE_COUNTER
	ENDM

RESET_TXRX MACRO	
	LDA #(TX_DOING+RX_DOING)
	TRB <NUSP_FLAG
	LDA #(SDA_TX+SDA_OUT0+CMD_UNDO)
	TRB <NUSP_FLAG1
	CLEAR_RX_RAM
	CLEAR_TX_RAM

;SDA:output->input	
	LDA #SDA_PORT_D_BIT
	TSB !SDA_PORT_D	

	REFRESH_SCLK_SDA
	STZ <TXRX_GAP
	ENDM
;-------------------------------------------	
CLEAR_STANDBY_RAM MACRO	
.IFDEF STANDBY_TIME
	STZ <STANDBY_COUNT
	STZ <STANDBY_COUNT+1
.ENDIF
	ENDM
;-------------------------------------------
SP_FREE_SPBUSY_OUT MACRO
.IFDEF SPBUSY_OUT_PIN		
	LDA <NUSP_FLAG1
	BIT #SPBZOUT_EN 
	BEQ 5
	LDA #SPBUSY_OUT_PORT_BIT
	TSB !SPBUSY_OUT_PORT
.ENDIF
	ENDM

SP_BUSY_SPBUSY_OUT MACRO
.IFDEF SPBUSY_OUT_PIN		
	LDA <NUSP_FLAG1
	BIT #SPBZOUT_EN 
	BEQ 5
	LDA #SPBUSY_OUT_PORT_BIT
	TRB !SPBUSY_OUT_PORT
.ENDIF
	ENDM
;-------------------------------------------
DO_PIN_CONFIG MACRO BIT_TYPE,BIT_PORT_D_BIT,BIT_PORT_D
.IFDEF SPBUSY_OUT_PIN
.IF (BIT_TYPE.EQ.SPBUSY_OUT_IOFLAG)
	LDA #SPBZOUT_EN
	BIT <NUSP_FLAG1
	BEQ SET_CONFIG_JMP#

	LDA #SPBUSY_OUT_IOFLAG
	TRB <IO_FLAG
	BRA NEXT_CONFIG_JMP#
.ENDIF
.ENDIF	
SET_CONFIG_JMP#:
	LDA <IO_FLAG	
	BIT #BIT_TYPE
	BEQ 7
	LDA #BIT_PORT_D_BIT
	TSB !BIT_PORT_D
	BRA 5
	LDA #BIT_PORT_D_BIT
	TRB !BIT_PORT_D
NEXT_CONFIG_JMP#:
	ENDM
;-------------------------------------------
SET_OUT_VALUE MACRO BIT_LOC,BIT_PORT_D_BIT,BIT_PORT_D,BIT_PORT_BIT,BIT_PORT
.IFDEF SPBUSY_OUT_PIN
.IF (BIT_LOC.EQ.SPBUSY_OUT_IOFLAG)
	LDA #SPBZOUT_EN
	BIT <NUSP_FLAG1
	BNE NEXT_SET_OUT_VALUE_JMP#
.ENDIF	
.ENDIF
SET_OUT_VALUE_JMP#:
	LDA #BIT_PORT_D_BIT
	BIT !BIT_PORT_D
	BNE NEXT_SET_OUT_VALUE_JMP#
	LDA <RX_DATA+1
	BIT #BIT_LOC
	BEQ 7
	LDA #BIT_PORT_BIT
	TSB !BIT_PORT
	BRA 5
	LDA #BIT_PORT_BIT
	TRB !BIT_PORT
NEXT_SET_OUT_VALUE_JMP#:
	ENDM
;-------------------------------------------
SP_FREE_WITHOUT_PA MACRO
	LDA #SP_BUSY
	TRB <STATUS_FLAG
	STZ <PLAY_LIST_INDEX
	STZ <PLAY_LIST_INDEX+1
	STZ <PLAY_REPEAT_COUNT
	SP_FREE_SPBUSY_OUT	
	ENDM
;-------------------------------------------
SP_FREE_PROC MACRO
	SP_FREE_WITHOUT_PA
	CLOSE_PA	
	ENDM
;-------------------------------------------
WAIT_HWENG_OFF MACRO
WAIT_HWENG_OFF_LOOP#:   
	LDA #WDTC_CLR
	STA !WDTC
	LDA !HWENG
	BNE WAIT_HWENG_OFF_LOOP#
	ENDM
;-------------------------------------------
NSP_RESET_HWE MACRO	
	LDA #01H
	TRB HWE_CTRL_BA
	ENDM
;-------------------------------------------
NSP_RESET_HWE_AFTER_ISP_PARTIAL MACRO	
	LDA #10H		;ISP  flag
	TRB !HWE_CTRL_BA
	STZ !HWENG
	LDA #01H
	TRB HWE_CTRL_BA
	ENDM
;-------------------------------------------	
SET_SP_VOLUME_RT_RAM_NST MACRO VOLUME_RAM, CHANNEL_ID
.IF (WITH_VOL_ADJ .EQ. 1).OR.(WITH_VOL_ADJ_MS .EQ. 1)
        JSR HWE_READY_PROC
        JSR NSP_CHK_SYS_HANDSHAKE_PROC
        PHP
        SEI

        HWE_SET_PARAMETER0_RAM VOLUME_RAM
        HWE_SET_PARAMETER1 VOL_CHANGE_IMMEDIATELY

        HWE_SET_COMMAND CHANNEL_ID, CMD_SET_VOL

        PLP

.ENDIF
        ENDM
;-------------------------------------------        
STOP_FOR_NST MACRO CHANNEL_ID
        LDA !HWENG
        BIT #01H
        BNE 3
        JMP STOP_PLAY_SP_CHANNEL_NEXT#

        JSR HWE_READY_PROC  
        JSR NSP_CHK_SYS_HANDSHAKE_PROC
        PHP
        SEI

        LDA #CHANNEL_ID
        STA HWE_CMD_BA+CMD_CH_IDX
        LDA #CMD_STOP
        STA HWE_CMD_BA+CMD_IDX
	LDA #02H
	TSB !INTRF

.IF (WITH_SLD_ENABLE .EQ. 1)
        EXTERN SLD_STOP
        JSR SLD_STOP
.ENDIF

        PLP
STOP_PLAY_SP_CHANNEL_NEXT#: 
	ENDM
;-------------------------------------------
NSP_RESET_HWE_SETTING MACRO
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	HW_CMD_EN_INSERT_PLAY
.ENDIF
	EN_GLOBALVOL_VOL1
	SET_SP_VOLUME_RT_RAM_NST SP_VOLUME,00
	ENDM
;-------------------------------------------
SET_IDLE_FLAG MACRO
	LDA !HWENG
	BEQ END_SET_IDLE_FLAG#	
        LDA HWE_CMD_BA+CMD_IDX
        BNE END_SET_IDLE_FLAG#

; enable HWE idle notifications
        PHP
        SEI
        LDA #02H
        TSB HWE_CTRL_BA
        PLP
END_SET_IDLE_FLAG#:
	ENDM
;-------------------------------------------	
CMD_CHK_CHECKSUM MACRO
	LDA <RX_CHKSUM
	CMP #FFH
	BEQ 3
	JMP READ_SDA_NOT_VALID
	ENDM	
;-----------------------------------------	
MULTI_PLAY_CHK_INDEX  MACRO JMP_LABEL_RIGHT,JMP_LABEL_NEXT,JMP_LABEL_WRONG		
	LDA <RAM_BUFFER+1
	ORA <RAM_BUFFER
	BEQ MULTI_PLAY_NEXT#

	LDA <RAM_BUFFER+1		;H
	CMP <PLAY_LIST_COUNT+1	;;H 
	BCC MULTI_PLAY_CHK_INDEX_NEXT#
	BEQ MULTI_PLAY_CHK_INDEX_CHK#
	BRA MULTI_PLAY_NEXT#

MULTI_PLAY_CHK_INDEX_CHK#:
	LDA <RAM_BUFFER			;;L
	CMP <PLAY_LIST_COUNT	;; L
	BCC MULTI_PLAY_CHK_INDEX_NEXT#	;;<
	BEQ MULTI_PLAY_CHK_INDEX_NEXT#	;;=
	BRA MULTI_PLAY_NEXT#

MULTI_PLAY_CHK_INDEX_NEXT#:
	BRA JMP_LABEL_RIGHT

MULTI_PLAY_NEXT#:
	INC <MULTI_PLAY_INDEX
	LDA <MULTI_PLAY_INDEX
	CMP <MULTI_PLAY_NUMBER
	BCC JMP_LABEL_NEXT
	JMP JMP_LABEL_WRONG	
	ENDM
;-----------------------------------------
;-----------------------------------------
HW_CMD_EN_INSERT_PLAY	MACRO
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC
	PHP
	SEI
	HWE_SET_COMMAND 0, HW_EN_INSERT_PLAY
	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM
;-----------------------------------------
HW_CMD_DIS_INSERT_PLAY MACRO CLEAR
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC
	PHP
	SEI
	HWE_SET_PARAMETER0 CLEAR		;;0:keep stakc, 1:clear stack
	HWE_SET_COMMAND 0, HW_DIS_INSERT_PLAY  ;;speech ch1 
	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM
;-----------------------------------------
HW_CMD_WRITE_DATA MACRO PARAMETERS_0,PARAMETERS_1,PARAMETERS_2,PARAMETERS_3
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC	
	PHP
	SEI
	LDA PARAMETERS_0
	STA HWE_CMD_BA+CMD_PARAMETER 
	LDA PARAMETERS_1
	STA HWE_CMD_BA+CMD_PARAMETER+1
	LDA PARAMETERS_2
	STA HWE_CMD_BA+CMD_PARAMETER+2
	LDA PARAMETERS_3
	STA HWE_CMD_BA+CMD_PARAMETER+3
	LDA #HW_WRITE_DATA
	JSR SEND_CMD_PROC

	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM
;-----------------------------------------
HW_CMD_READ_DATA MACRO PARAMETERS_0,PARAMETERS_1,PARAMETERS_2,PARAMETERS_3
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC	
	PHP
	SEI
	LDA #HW_READ_DATA
	JSR SEND_CMD_PROC
	PLP
	JSR NSP_CHK_SYS_HANDSHAKE_PROC

	LDA HWE_CMD_BA+CMD_PARAMETER 
	STA PARAMETERS_0 
	LDA HWE_CMD_BA+CMD_PARAMETER+1 
	STA PARAMETERS_1
	LDA HWE_CMD_BA+CMD_PARAMETER+2
	STA PARAMETERS_2
	LDA HWE_CMD_BA+CMD_PARAMETER+3
	STA PARAMETERS_3
	ENDM
;-----------------------------------------
HW_CMD_PUSH_PLAY MACRO CHID
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC	
	PHP
	SEI
	HWE_SET_COMMAND CHID, HW_PUSH_PLAY ;;speech ch1 
	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM	
;-----------------------------------------
HW_CMD_POP_PLAY MACRO CHID,PAUSE_CH
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC	
	PHP
	SEI
	HWE_SET_PARAMETER0 PAUSE_CH		;;1:pause channel, 0:resume channel
	HWE_SET_COMMAND CHID, HW_POP_PLAY ;	;speech ch1  
	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM	
;-----------------------------------------
HW_CMD_DEL_PUSH_LAYER MACRO DEL_LAYER
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC		
	PHP
	SEI
	HWE_SET_PARAMETER0 DEL_LAYER+8		;;Delete 1 layer from stack bottom
	HWE_SET_COMMAND 0, HW_DEL_PUSH_LAYER    ;;speech ch1 
	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM	
;-----------------------------------------
HW_CMD_DEL_PUSH_LAYER_RAM MACRO DEL_LAYER_RAM
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC	
	PHP
	SEI
	LDA DEL_LAYER_RAM
	ORA #08H
	STA HWE_CMD_BA+CMD_PARAMETER
	HWE_SET_COMMAND 0, HW_DEL_PUSH_LAYER    ;;speech ch1 
	PLP
	JSR CHK_HANDSHAKE_PROC
	ENDM	
;-----------------------------------------
HW_CMD_GET_FREE_LAYER MACRO
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC	
	PHP
	SEI
	HWE_SET_PARAMETER0 00H		
	HWE_SET_COMMAND 0, HW_GET_PUSH_LAYER ;;speech ch1
	PLP
	JSR CHK_HANDSHAKE_PROC
	LDA HWE_CMD_BA+CMD_PARAMETER 
	AND #0FH 
	ENDM	
;-----------------------------------------
CHK_BUSY_SENTENCE MACRO
	LDA HWE_CH1_BA
	BIT #SENTENCE_BUSY
	ENDM
;-----------------------------------------
CHK_CH1_SENTENCE_BUSY	MACRO
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	LDA <NUSP_FLAG 
	BIT #PLAY_PAUSE
	BEQ CH1_NOT_CONTINUE_PLAY#

	CHK_BUSY_SENTENCE
	BRA END_CHK_CH1_SENTENCE_BUSY#
CH1_NOT_CONTINUE_PLAY#:
.ENDIF
	CHK_BUSY_CH1
END_CHK_CH1_SENTENCE_BUSY#:
	ENDM
;-----------------------------------------
SET_SPEECH_BUSY_RT	MACRO	
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	LDA <NUSP_FLAG 
	BIT #PLAY_PAUSE
	BEQ SET_COMMON_BUSY_RT#

	LDA #SENTENCE_BUSY 
	TSB HWE_CH1_BA 
	BRA END_SET_SPEECH_BUSY_RT#
SET_COMMON_BUSY_RT#:
.ENDIF
	LDA #CH_SP1_BZ 			;Only play command
	TSB HWE_CH_BUSY_BA              ;Only play command
END_SET_SPEECH_BUSY_RT#:
	ENDM
;-----------------------------------------
CHK_CONTINUE_PLAY_UNSUPPORTED	MACRO
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	LDA <NUSP_FLAG
	BIT #PLAY_PAUSE
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
.ENDIF
	ENDM
;-----------------------------------------
CLEAR_CONTINUE_PLAY_RAM	MACRO
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	STZ PLAY_LAYER_INDEX
	LDX #0H
CLEAR_CONTINUE_PLAY_RAM_LOOP1#:
	STZ PLAY_FLAG_RAM,X
.IF (CONTINUE_PLAY_LAYER .GT. 1)
	INX
	CPX #CONTINUE_PLAY_LAYER
	BNE CLEAR_CONTINUE_PLAY_RAM_LOOP1#
.ENDIF

	LDX #0H
CLEAR_CONTINUE_PLAY_RAM_LOOP2#:
	STZ CONTINUE_PLAY_RAM,X
	INX
	CPX #CONTINUE_PLAY_LAYER_RAM
	BNE CLEAR_CONTINUE_PLAY_RAM_LOOP2#
.ENDIF
	ENDM
;-----------------------------------------
SET_SDA_OUT0_FLAG MACRO	
	LDA #SDA_OUT0
	TSB <NUSP_FLAG1
	ENDM
;==========================================================================
;-----------------------------------------------------------------------------------
; XX0 SOP14
;Set BP0[7,6,5,4,3,2,1,0]
;		 | | | | | | | |__SCL(IN)
;		 | | | | | | |____SDA(IN/OUT) 
;		 | | | | | |______SPBUSY_OUT / IO(default)
;		 | | | | |________  
;		 | | | |__________
;		 | | |____________         
;		 | |______________PA(OUT)=0/1:disable/enable
;		 |________________
; 
;Set BP1[7,6,5,4,3,2,1,0]
;		 | | | | | | | |__
;		 | | | | | | |____
;		 | | | | | |______
;		 | | | | |________
;		 | | | |__________
;		 | | |____________         
;		 | |______________ 
;		 |________________   
;
; XX1 SOP14
;Set BP0[7,6,5,4,3,2,1,0]
;		 | | | | | | | |__SCL(IN)
;		 | | | | | | |____SDA(IN/OUT) 
;		 | | | | | |______SPBUSY_OUT / IO(default)
;		 | | | | |________  
;		 | | | |__________
;		 | | |____________         
;		 | |______________
;		 |________________  
; 
;Set BP1[7,6,5,4,3,2,1,0]
;		 | | | | | | | |__
;		 | | | | | | |____
;		 | | | | | |______
;		 | | | | |________
;		 | | | |__________
;		 | | |____________
;		 | |______________PA(OUT)=0/1:disable/enable
;		 |________________
;-----------------------------------------------------------------------------------
;480/650/960 SOP14
;Set BP0[7,6,5,4,3,2,1,0]
;		 | | | | | | | |__SCL(IN)
;		 | | | | | | |____SDA(IN/OUT) 
;		 | | | | | |______
;		 | | | | |________  
;		 | | | |__________
;		 | | |____________         
;		 | |______________
;		 |________________  
; 
;Set BP1[7,6,5,4,3,2,1,0]
;		 | | | | | | | |__
;		 | | | | | | |____
;		 | | | | | |______SPBUSY_OUT / IO(default)
;		 | | | | |________
;		 | | | |__________
;		 | | |____________
;		 | |______________
;		 |________________PA(OUT)=0/1:disable/enable
;--------------------------------------------------------------------------
BIT0		EQU 00000001B
BIT1		EQU 00000010B
BIT2		EQU 00000100B
BIT3		EQU 00001000B
BIT4		EQU 00010000B
BIT5		EQU 00100000B
BIT6		EQU 01000000B
BIT7		EQU 10000000B
;--------------------------------------------------------------------------
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
BP20_TYPE   	EQU BIT0
BP20_LOC    	EQU BIT0
BP20_PORT_D 	EQU BP2D
BP20_PORT_D_BIT EQU BIT0
BP20_PORT   	EQU BP2R
BP20_PORT_BIT   EQU BIT0
BP20_PORT_EN  	EQU BP2EN
.ENDIF

BP17_TYPE   	EQU BIT7
BP17_LOC    	EQU BIT7
BP17_PORT_D 	EQU BP1D
BP17_PORT_D_BIT EQU BIT7
BP17_PORT   	EQU BP1R
BP17_PORT_BIT   EQU BIT7
BP17_PORT_EN  	EQU BP1EN

BP16_TYPE   	EQU BIT6
BP16_LOC    	EQU BIT6
BP16_PORT_D 	EQU BP1D
BP16_PORT_D_BIT EQU BIT6
BP16_PORT   	EQU BP1R
BP16_PORT_BIT   EQU BIT6
BP16_PORT_EN  	EQU BP1EN

BP15_TYPE   	EQU BIT5
BP15_LOC    	EQU BIT5
BP15_PORT_D 	EQU BP1D
BP15_PORT_D_BIT EQU BIT5
BP15_PORT   	EQU BP1R
BP15_PORT_BIT   EQU BIT5
BP15_PORT_EN  	EQU BP1EN

BP13_TYPE   	EQU BIT3
BP13_LOC    	EQU BIT3
BP13_PORT_D 	EQU BP1D
BP13_PORT_D_BIT EQU BIT3
BP13_PORT   	EQU BP1R
BP13_PORT_BIT   EQU BIT3
BP13_PORT_EN  	EQU BP1EN

BP12_TYPE   	EQU BIT2
BP12_LOC    	EQU BIT2
BP12_PORT_D 	EQU BP1D
BP12_PORT_D_BIT EQU BIT2
BP12_PORT   	EQU BP1R
BP12_PORT_BIT   EQU BIT2
BP12_PORT_EN  	EQU BP1EN

BP07_TYPE   	EQU BIT7
BP07_LOC    	EQU BIT7
BP07_PORT_D 	EQU BP0D
BP07_PORT_D_BIT EQU BIT7
BP07_PORT   	EQU BP0R
BP07_PORT_BIT   EQU BIT7
BP07_PORT_EN  	EQU BP0EN

BP06_TYPE   	EQU BIT6
BP06_LOC    	EQU BIT6
BP06_PORT_D 	EQU BP0D
BP06_PORT_D_BIT EQU BIT6
BP06_PORT   	EQU BP0R
BP06_PORT_BIT   EQU BIT6
BP06_PORT_EN  	EQU BP0EN

BP02_TYPE   	EQU BIT2
BP02_LOC    	EQU BIT2
BP02_PORT_D 	EQU BP0D
BP02_PORT_D_BIT EQU BIT2
BP02_PORT   	EQU BP0R
BP02_PORT_BIT   EQU BIT2
BP02_PORT_EN  	EQU BP0EN
;--------------------------------------------------------------------------
;--------------------------------------------------------------------------
.IFDEF SPBUSY_OUT_PIN
.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP02)
SPBUSY_OUT_PORT		EQU		BP02_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP02_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP02_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP02_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP02_TYPE
.ENDIF	

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP06)
SPBUSY_OUT_PORT		EQU		BP06_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP06_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP06_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP06_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP06_TYPE
.ENDIF

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP07)
SPBUSY_OUT_PORT		EQU		BP07_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP07_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP07_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP07_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP07_TYPE
.ENDIF	

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP12)
SPBUSY_OUT_PORT		EQU		BP12_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP12_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP12_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP12_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP12_TYPE
.ENDIF	

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP13)
SPBUSY_OUT_PORT		EQU		BP13_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP13_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP13_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP13_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP13_TYPE
.ENDIF

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP15)
SPBUSY_OUT_PORT		EQU		BP15_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP15_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP15_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP15_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP15_TYPE
.ENDIF	

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP16)
SPBUSY_OUT_PORT		EQU		BP16_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP16_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP16_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP16_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP16_TYPE
.ENDIF

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP17)
SPBUSY_OUT_PORT		EQU		BP17_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP17_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP17_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP17_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP17_TYPE
.ENDIF	

.IF	(SPBUSY_OUT_PIN .EQ. PIN_BP20)
SPBUSY_OUT_PORT		EQU		BP20_PORT
SPBUSY_OUT_PORT_BIT	EQU		BP20_PORT_BIT
SPBUSY_OUT_PORT_D	EQU		BP20_PORT_D
SPBUSY_OUT_PORT_D_BIT   EQU		BP20_PORT_D_BIT
SPBUSY_OUT_IOFLAG	EQU		BP20_TYPE
.ENDIF	
.ENDIF
;--------------------------------------------------------------------------
SCLK_PORT		EQU	BP0R
SCLK_PORT_BIT	EQU	BIT0
SCLK_PORT_D		EQU	BP0D
SCLK_PORT_D_BIT	EQU	BIT0
SCLK_PORT_EN	EQU	BP0EN
SDA_PORT		EQU	BP0R
SDA_PORT_BIT	EQU	BIT1
SDA_PORT_D		EQU	BP0D
SDA_PORT_D_BIT	EQU	BIT1
SDA_PORT_EN		EQU	BP0EN
;--------------------------------------------------------------------------
.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
.IFDEF EXT_PA
PA_OUT_PORT		EQU		BP0R
PA_OUT_PORT_D	EQU		BP0D
PA_OUT_PORT_M	EQU		BP0M
PA_OUT_PORT_BIT	EQU		BIT6
.ENDIF
.ENDIF

.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
.IFDEF EXT_PA
PA_OUT_PORT		EQU		BP1R
PA_OUT_PORT_D	EQU		BP1D
PA_OUT_PORT_M	EQU		BP1M
PA_OUT_PORT_BIT	EQU		BIT6
.ENDIF
.ENDIF

.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
.IFDEF EXT_PA
PA_OUT_PORT		EQU		BP1R
PA_OUT_PORT_D	EQU		BP1D
PA_OUT_PORT_M	EQU		BP1M
PA_OUT_PORT_BIT	EQU		BIT7
.ENDIF
.ENDIF
;--------------------------------------------------------------------------
SP_BUSY			EQU BIT7
CMD_VALID		EQU BIT6

RX_DOING		EQU BIT7
TX_DOING		EQU BIT6
SP_DOING		EQU BIT5
SIL_DOING		EQU BIT4
PLAY_REPEAT		EQU BIT3
MULTI_PLAY		EQU BIT2
SLEEP_AFTER		EQU BIT1
PLAY_PAUSE		EQU BIT0

SDA_TX			EQU BIT6
SDA_OUT0		EQU BIT5
LVD_DOING		EQU BIT4
EN_STANDBY		EQU BIT3
ENTER_STANDBY		EQU BIT2
SPBZOUT_EN		EQU BIT1
CMD_UNDO		EQU BIT0
;--------------------------------------------------------------------------
LVDC_V21		EQU 00000001B
LVDC_V24		EQU 00000011B
LVDC_V27		EQU 00000101B
LVDC_V30		EQU 00000111B
LVDC_V33		EQU 00001001B

CMD_LVD_LESS_THAN_V21	EQU 01H
CMD_LVD_V21_V24			EQU 02H
CMD_LVD_V24_V27			EQU 04H
CMD_LVD_V27_V30			EQU 08H
CMD_LVD_V30_V33			EQU 10H
CMD_LVD_MORE_THAN_V33	EQU 20H
;--------------------------------------------------------------------------
CMD_READ_ID			EQU 	10H
CMD_READ_STATUS		EQU 	11H
CMD_DO_LVD			EQU 	12H
CMD_GET_LVD			EQU 	13H
CMD_CHECKSUM_RIGHT	EQU 	14H
CMD_GET_CHECKSUM	EQU 	15H
CMD_DO_CHECKSUM		EQU 	16H
CMD_GET_FW_VERSION	EQU 	17H
CMD_CHECK_INDEX_RCOUNT	EQU 	76H
CMD_GET_INDEX_RCOUNT	EQU	77H
CMD_PAUSE_PLAY		EQU 	78H
CMD_RESUME_PLAY		EQU 	79H
CMD_STOP_REPEAT		EQU 	7BH
CMD_REPEAT		EQU 	7CH
CMD_MULTI_PLAY		EQU	7DH
CMD_MULTI_PLAY_2B	EQU	7AH
CMD_PLAY_SLEEP		EQU 	7EH
CMD_PLAY_EQU		EQU 	7FH
CMD_STOP_EQU		EQU 	80H
CMD_PWR_DOWN		EQU 	82H
CMD_RESET			EQU 	81H
CMD_SLEEP_EN		EQU	83H
CMD_SLEEP_DIS		EQU	84H
CMD_IO_CONFIG		EQU 	88H
CMD_IO_TYPE			EQU 	89H
CMD_SET_OUT			EQU 	8AH
CMD_GET_INOUT		EQU 	8BH
CMD_SPBZOUT_EN		EQU 	8EH
CMD_SPBZOUT_DIS		EQU 	8FH
CMD_ISP_WRITE_START	EQU 	D0H
CMD_ISP_WRITE_END	EQU 	D1H
CMD_ISP_WRITE_PAGE	EQU 	D2H
CMD_ISP_READ_PAGE	EQU 	D3H
CMD_ISP_CHECKSUM	EQU 	D4H
CMD_ISP_READ_RES_INDEX  EQU 	D5H
CMD_ISP_GET_RES_INFO 	EQU 	D6H
CMD_ISP_WRITE_PARTIAL_START EQU D7H
CMD_ISP_WRITE_PARTIAL_BAK EQU 	D8H
CMD_ISP_WRITE_PARTIAL   EQU 	D9H
CMD_ISP_READ_PARTIAL	EQU	DAH
CMD_ISP_GET_USER_SPACE_INFO	EQU	DBH
CMD_SET_VOL_NSP		EQU 	F0H
CMD_GET_VOL			EQU 	F1H

RIGHT_RTN			EQU	A5H
ERROR_RTN			EQU	FAH
UNSUPPORTED_RTN		EQU	5FH
;--------------------------------------------------------------------------
DPD_RAM_SIZE		EQU	19
;--------------------------------------------------------------------------
;lase page -40(38) byte
;lase page -56(54) byte
.IF (PARTNO='N589D080').OR.(PARTNO='N589D081')
READ_ISP_ADDR			EQU	020FD8H
READ_USER_DATA_ADDR		EQU	020FC8H
.ENDIF
.IF (PARTNO='N589D170').OR.(PARTNO='N589D171')
READ_ISP_ADDR			EQU	030FD8H
READ_USER_DATA_ADDR		EQU	030FC8H
.ENDIF
.IF (PARTNO='N589D340').OR.(PARTNO='N589D341')
READ_ISP_ADDR			EQU	060FD8H
READ_USER_DATA_ADDR		EQU	060FC8H
.ENDIF
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D481')
READ_ISP_ADDR			EQU	080FD8H
READ_USER_DATA_ADDR		EQU	080FC8H
.ENDIF
.IF (PARTNO='N589D650N')
READ_ISP_ADDR			EQU	0C0FD8H
READ_USER_DATA_ADDR		EQU	0C0FC8H
.ENDIF
.IF (PARTNO='N589D960N')
READ_ISP_ADDR			EQU	100FD8H
READ_USER_DATA_ADDR		EQU	100FC8H
.ENDIF

CHIP_PDID_ADDR 			EQU 0FD3H

ISP_WRITE_PAGE_BUFFER		EQU 	HWE_STACK_BEGIN
ISP_WRITE_PAGE_SIZE		EQU 200H
ISP_WRITE_READ_SIZE		EQU 200H
SYSCFG1_ISP			EQU	ISP_WRITE_PAGE_BUFFER+ISP_WRITE_PAGE_SIZE
;--------------------------------------------------------------------------
;--------------------------------------------------------------------------
MULTI_PLAY_NUMBER_MAX		EQU 32
;--------------------------------------------------------------------------
;--------------------------------------------------------------------------
HW_EN_INSERT_PLAY		EQU 2CH
HW_DIS_INSERT_PLAY		EQU 2DH
HW_WRITE_DATA			EQU 2EH
HW_READ_DATA			EQU 2FH
HW_PUSH_PLAY			EQU 30H
HW_POP_PLAY			EQU 31H
HW_DEL_PUSH_LAYER		EQU 32H
HW_GET_PUSH_LAYER		EQU 33H

HW_DIS_INPLAY_CLEAR_STACK	EQU 01H
HW_DIS_INPLAY_KEEP_STACK	EQU 00H
HW_POP_PAUSE			EQU 01H
HW_POP_RESUME			EQU 00H

SENTENCE_BUSY			EQU 10H
;==========================================================================
;	DECLARE VARIABLES INSIDE THIS SECTION
;	EXAMPLE => 	VAR1	DS	3
;		   		VAR2	DS	1
;==========================================================================
	USER_RAM: SECTION  
;-----------------------
; User's RAM for Program
;-----------------------
NUSP_FLAG		DS  1
;	bit7		bit6		bit5		bit4		bit3		bit2		bit1		bit0
;	RX_DOING        TX_DOING        SP_DOING        SIL_DOING       PLAY_REPEAT     MULTI_PLAY      SLEEP_AFTER     PLAY_PAUSE  				 

NUSP_FLAG1		DS 1
;	bit7		bit6		bit5		bit4		bit3		bit2		bit1		bit0
;	Reserved	SDA_TX		SDA_OUT0	LVD_DOING	EN_STANDBY	ENTER_STANDBY 	SPBZOUT_EN	CMD_UNDO 

STATUS_FLAG		DS 1
;	bit7		bit6		bit5	 	bit4	    bit3		bit2		bit1		bit0
;	SP_BUSY 	VALID   	Reserved 	Reserved	Reserved  	Reserved	Reserved	Reserved


IO_FLAG			DS  1
;	 bit7		bit6		bit5		bit4		bit3		bit2		bit1		bit0
;XX0 BP07_TYPE 	BP06_TYPE	Reserved  	Reserved  	BP13_TYPE	BP02_TYPE	Reserved  	Reserved 
;XX1 BP17_TYPE 	BP16_TYPE	BP15_TYPE	Reserved	Reserved	BP02_TYPE	Reserved	Reserved

SP_VOLUME			DS 1
ID_RAM				DS 4
PLAY_LIST_COUNT		DS 2	;;chged 2017/4/7 17:31:51
PLAY_LIST_ADDR		DS 3
STARTADDR_PLAYLIST	DS 3

SDA_PREV			DS 1
SCLK_PREV			DS 1

RAM_BUFFER			DS 7
TX_DATA				DS 13
TX_BYTE_COUNTER		DS 1
TX_BYTE_INDEX		DS 1
;TX_BIT_INDEX		DS 1
RX_DATA				DS 8
RX_BYTE_COUNTER		DS 1
RX_BYTE_INDEX		DS 1
RX_BIT_INDEX		DS 1

EQU_COUNTER			DS 1	
EQU_INDEX			DS 2
EQU_ADDR			DS 3
SIL_COUNT   		DS 1

PLAY_TYPE		DS 1
PLAY_LIST_INDEX		DS 2
PLAY_REPEAT_COUNT	DS 1


CMD_JUMP			DS 2
LVD_VALUE			DS 1
LVD_INDEX			DS 1
LVD_COUNT			DS 1
TXRX_GAP			DS 1
STANDBY_COUNT		DS 2

ISP_START_ADDR_RAM		DS 3
ISP_END_ADDR_RAM		DS 3
ISP_CHECKSUM_BYTE		DS 2
ISP_ADDR_RAM			DS 3
ISP_LEN_COUNT			DS 2
ISP_LEN					DS 2
ISP_LEN_READ			DS 0
TEMP_USED			DS 2

RX_DATA_CMD			DS 1
RX_CHKSUM			DS 1

MULTI_PLAY_INDEX		DS 1
MULTI_PLAY_NUMBER		DS 1
MULTI_PLAY_BUFFER		DS 64

ISP_SWAP_RAM                    DS 3
ISP_PARTIAL_REAL_SIZE_RAM       DS 3
ISP_RAM_BUFFER                  DS 15
ISP_PARTIAL_HEAD_PAGE_RAM       EQU ISP_RAM_BUFFER
ISP_PARTIAL_TAIL_PAGE_RAM       EQU ISP_PARTIAL_HEAD_PAGE_RAM+3
ISP_PARTIAL_PAGE_COUNT_RAM      EQU ISP_PARTIAL_TAIL_PAGE_RAM+3
ISP_PARTIAL_START_ADDR_RAM      EQU ISP_PARTIAL_PAGE_COUNT_RAM+2
ISP_PARTIAL_HEAD_BYTE_RAM       EQU ISP_PARTIAL_START_ADDR_RAM+3
ISP_PARTIAL_TAIL_BYTE_RAM       EQU ISP_PARTIAL_HEAD_BYTE_RAM+2

RAM_BUFFER2			DS 66
MULTI_PLAY_INDEX_RX		EQU RAM_BUFFER2
MULTI_PLAY_NUMBER_RX		EQU RAM_BUFFER2+1
MULTI_PLAY_BUFFER_RX		EQU RAM_BUFFER2+2

.IF (WITH_CONTINUE_PLAY .EQ. 1)
CONTINUE_PLAY_LAYER	EQU     1
CONTINUE_PLAY_LAYER_RAM	EQU     11+66
CONTINUE_RAM_PLAY	EQU     11
CONTINUE_RAM_PLAY_MULTI	EQU     66

PLAY_LAYER_INDEX	DS	1
PLAY_FLAG_RAM		DS 	CONTINUE_PLAY_LAYER
CONTINUE_PLAY_RAM	DS	CONTINUE_PLAY_LAYER*CONTINUE_PLAY_LAYER_RAM
.ENDIF

RESOURCE_COUNT		DS 	1
	ENDS

	USER_DPD_RAM: SECTION
;-----------------------
; User's DPD RAM for Program
;-----------------------
CHECKSUM_BYTE		DS 3
NUSP_FLAG_BAK		DS 1
NUSP_FLAG1_BAK		DS 1
STATUS_FLAG_BAK		DS 1
IO_FLAG_BAK			DS 1
SP_VOLUME_BAK		DS 1
ID_RAM_BAK			DS 4
PLAY_LIST_COUNT_BAK	DS 2	;;chged 2017/4/7 17:31:51
PLAY_LIST_ADDR_BAK	DS 3
STARTADDR_PLAYLIST_BAK	DS 3

SDA_PREV_BAK		DS 1
SCLK_PREV_BAK		DS 1
	ENDS

.IF	(WITH_RAM_OVER_STACK .EQ. 1)
	USER_RAM_AFTER_RESERVED: SECTION

	ENDS
.ENDIF

;==========================================================================
;	WRITE PROGRAM CODES & TABLES INSIDE THIS SECTION
;==========================================================================
	CODE: SECTION

;==========================================================================
; INTERRUPT SERVICE ROUTINES
;==========================================================================
;===============================================================
;  SR_NAME: PORT_ISR
;===============================================================
PORT_ISR:
	PHA
	LDA #INT0_PORT
	STA !EVF0
;User can insert program from here

	PLA
	RTI

;===============================================================
;  SR_NAME: FXF10_ISR
;===============================================================
FXF10_ISR:
	PHA
	LDA #INT0_FXF10
	STA !EVF0							;CLEAR EVF OF FXF10
;User can insert program from here

.IFDEF	FW_PWM_TIMER_FXF10
	JMP FW_PWM_TIMER_DOWNCOUNT
FW_TIMER_DWONCOUNT_RET:
.ENDIF

.IFDEF	COLOR_FLY_TIMER_FXF10
	JMP COLOR_FLY_TIMER_DOWNCOUNT
COLOR_FLY_DWONCOUNT_RET:
.ENDIF

	LDA #LVD_DOING
	BIT <NUSP_FLAG1
	BEQ FXF10_ISR_END
	DEC <LVD_COUNT
	LDA <LVD_COUNT
	BNE FXF10_ISR_END

	LDA !LVDC
	BIT #80H
	BEQ LVD_DONE

	INC <LVD_INDEX
	LDA <LVD_INDEX
	CMP #05H
	BCS LVD_DONE
FXF10_LVD_NEXT:
	LDA #03H
	STA <LVD_COUNT
	LDX <LVD_INDEX
	LDA !LVDC_SETTNG_TABLE,X
	STA !LVDC
	BRA FXF10_ISR_END

LVD_DONE:
	DEC <LVD_INDEX
	LDX <LVD_INDEX
	LDA !LVDC_VALUE_TABLE,X
	STA !LVD_VALUE

	LDA #00H
	STA !LVDC
	LDA #LVD_DOING
	TRB <NUSP_FLAG1
	LDA #INT0_FXF10
	TRB !IEF0

FXF10_ISR_END:
	PLA
	RTI

;===============================================================
;  SR_NAME: FXF13_ISR
;===============================================================
FXF13_ISR:
	PHA
	LDA #INT0_FXF13
	STA !EVF0     						;CLEAR EVF OF FXF13
;User can insert program from here


	PLA
	RTI

;===============================================================
;  SR_NAME: FXF15_ISR
;===============================================================
FXF15_ISR:
	PHA
	LDA #INT0_FXF15
	STA !EVF0							;CLEAR EVF OF FXF15
;User can insert program from here

	LDA #(TX_DOING+RX_DOING)
	BIT <NUSP_FLAG
	BEQ FXF15_ISR_CHK_STANDBY	
	LDA <TXRX_GAP
	CMP #CMD_TIMEOUT
	BNE FXF15_ISR_INC_GAP
	RESET_TXRX
	JMP FXF15_ISR_CHK_DIS
FXF15_ISR_INC_GAP:
	INC <TXRX_GAP
	JMP FXF15_ISR_CHK_DIS

FXF15_ISR_CHK_STANDBY:
.IFDEF STANDBY_TIME
	LDA #ENTER_STANDBY
	BIT <NUSP_FLAG1
	BEQ FXF15_ISR_CHK_DIS
	CLC
	LDA <STANDBY_COUNT
	ADC #01H
	STA <STANDBY_COUNT
	LDA <STANDBY_COUNT+1
	ADC #00H
	STA <STANDBY_COUNT+1
.ENDIF

FXF15_ISR_CHK_DIS:
	LDA #(TX_DOING+RX_DOING)
	BIT <NUSP_FLAG
	BNE FXF15_ISR_QUIT

	LDA #ENTER_STANDBY
	BIT <NUSP_FLAG1
	BNE FXF15_ISR_QUIT

	LDA #INT0_FXF15
	TRB !IEF0	
FXF15_ISR_QUIT:
	PLA
	RTI	

;===============================================================
;  SR_NAME: TIMERA_ISR
;===============================================================
TMA_ISR:
	PHA
	LDA #INT0_TMA
	STA !EVF0							;CLEAR EVF OF TIMERA
;User can insert program from here

.IFDEF	FW_PWM_TIMER_TMA
	JMP FW_PWM_TIMER_DOWNCOUNT
FW_TIMER_DWONCOUNT_RET:
.ENDIF

.IFDEF	COLOR_FLY_TIMER_TMA
	JMP COLOR_FLY_TIMER_DOWNCOUNT
COLOR_FLY_DWONCOUNT_RET:
.ENDIF

	PLA
	RTI

;===============================================================
;  SR_NAME: TIMERG_ISR
;===============================================================
TMG_ISR:
	PHA
	LDA #INT0_TMG
	STA !EVF0							;CLEAR EVF OF TIMERG
;User can insert program from here

	.IF(WITH_FW_CAP_SENSOR_KEYS .GT. 0)
	CAP_TMG_OVER
	.ENDIF

.IFDEF	FW_PWM_TIMER_TMG
	JMP FW_PWM_TIMER_DOWNCOUNT
FW_TIMER_DWONCOUNT_RET:
.ENDIF

.IFDEF	COLOR_FLY_TIMER_TMG
	JMP COLOR_FLY_TIMER_DOWNCOUNT
COLOR_FLY_DWONCOUNT_RET:
.ENDIF

	PLA
	RTI

;===============================================================
;  SR_NAME: LRCT_ISR			
;===============================================================
LRCT_ISR:
	PHA
	LDA #INT1_LRCT
	STA !EVF1							;CLEAR EVF OF LRCT
;User can insert program from here

	PLA
	RTI

;===============================================================
;  SR_NAME: ADC_ISR			
;===============================================================
ADC_ISR:
	PHA
	LDA #INT1_ADC
	STA !EVF1							;CLEAR EVF OF ADC
;User can insert program from here

	PLA
	RTI
;===============================================
; I/O setting before entering CAP sleep
;===============================================
PREPARE_FOR_CAP_SLEEP_SETTING:
;-----------------------
; User's Program before Entering CAP SLEEP
;-----------------------


	RTS
;===============================================
;===============================================
DO_CHECKSUM_PROCESS:
;-----------add for checksum--------------	
	LDA <CHECKSUM_ADDR1
	PHA
	LDA <CHECKSUM_ADDR
	PHA
	LDA <CHECK_RESULT+1
	PHA
	LDA <CHECK_RESULT
	PHA

	GET_CHECKSUM
	LDA <CHECK_RESULT
	STA CHECKSUM_BYTE
	LDA <CHECK_RESULT+1
	STA CHECKSUM_BYTE+1

	LDA #.high.CHECKSUM_33TH
	STA <CHECKSUM_ADDR1
	LDA #.low.CHECKSUM_33TH
	STA <CHECKSUM_ADDR	
	CLC
	LDA (<CHECKSUM_ADDR)
	ADC <CHECK_RESULT
	STA <CHECK_RESULT
	INC CHECKSUM_ADDR
	LDA (<CHECKSUM_ADDR)
	ADC <CHECK_RESULT+1
	STA <CHECK_RESULT+1
	LDA <CHECK_RESULT
	ORA <CHECK_RESULT+1
	BNE CHECKSUM_FAIL
CHECKSUM_OK:
	STZ CHECKSUM_BYTE+2
	BRA CHECKSUM_END
CHECKSUM_FAIL:
	LDA #01H
	STA CHECKSUM_BYTE+2
CHECKSUM_END:
	PLA
	STA <CHECK_RESULT
	PLA
	STA <CHECK_RESULT+1
	PLA
	STA <CHECKSUM_ADDR
	PLA
	STA <CHECKSUM_ADDR1	
	RTS
;-----------add for checksum--------------			
;===============================================
; Main program start here after resetting
;===============================================
MAIN_START:
	SYNTHESISER_OFF
	SET_STACK_POINTER_TO STACK_END			;USER CAN CHANGE THE VALUE
	SYSTEM_INIT_PROCEDURE					;SYSTEM INITIALIZATION PROCEDURE
	IO_INIT_PROCEDURE						;IO INITIALIZATION PROCEDURE
	.IF(WITH_FW_CAP_SENSOR_KEYS .GT. 0)
	.IF(TOUCH_WAKEUP_EN .EQ. 1)
	PREPARE_FOR_CAP_SLEEP
	CAP_WAKEUP_CHECK
   	.ENDIF
   	.ENDIF
INIT:
	CLEAR_RAM
	.IF(WITH_FW_CAP_SENSOR_KEYS .GT. 0)
	.IF(TOUCH_WAKEUP_EN .EQ. 1)
	CAP_SENSOR_INIT_FROM_WAKEUP
   	.ENDIF
   	.ENDIF
;CLI
	SPECIAL_REGISTERS_INIT

	LDA #WDTC_CLR
	STA !WDTC

	LDA !WAKEF
	BIT #20H     			;check POR
	BNE MAIN_START_INIT

	LDA !WAKEF
	BIT #80H
	BEQ MAIN_START_INIT_NEXT
	BIT #08H
	BNE MAIN_START_INIT_NEXT	;reset
	JMP WAKE_UP_FROM_SLEEP

MAIN_START_INIT:
.IF (WITH_ISP .EQ. 1)
	JSR CHECK_ISP_PARTIAL_ERROR
.ENDIF
.IFDEF AUTO_CHECKSUM
	JSR DO_CHECKSUM_PROCESS
.ENDIF	

MAIN_START_INIT_NEXT:
	LDA #01H							;add by ST suggestion
	STA !BANK

.IF (WITH_ISP .EQ. 1)
	JSR CHECK_ISP_PARTIAL_ERROR_DOUBLE
.ENDIF

	FLASH_READ READ_ISP_ADDR,6,RAM_BUFFER
	LDA <RAM_BUFFER+2
	STA <STARTADDR_PLAYLIST
	LDA <RAM_BUFFER+3
	STA <STARTADDR_PLAYLIST+1
	LDA <RAM_BUFFER+4
	STA <STARTADDR_PLAYLIST+2

;init ID_RAM(4B)+CHIP_PDID(4B)+PLAY_LIST_COUNT(2B)	
	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM STARTADDR_PLAYLIST,ISP_LEN,ID_RAM
	ADC_ADDR_DP	STARTADDR_PLAYLIST,8,PLAY_LIST_ADDR	
	LDA #02H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM PLAY_LIST_ADDR,ISP_LEN,PLAY_LIST_COUNT

;init BP0:pull-high input
	INIT_PA
.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
	LDA #(BP07_PORT_D_BIT+BP02_PORT_D_BIT+SCLK_PORT_D_BIT+SDA_PORT_D_BIT)
.IFNDEF EXT_PA
	ORA #BP06_PORT_D_BIT
.ENDIF
	TSB !BP0M
	TSB !BP0R
	TSB !BP0D
	LDA #BP13_PORT_D_BIT
	TSB !BP1M
	TSB !BP1R
	TSB !BP1D
.ENDIF
.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
	LDA #(BP02_PORT_D_BIT+SCLK_PORT_D_BIT+SDA_PORT_D_BIT)
	TSB !BP0M
	TSB !BP0R
	TSB !BP0D
	LDA #(BP17_PORT_D_BIT+BP15_PORT_D_BIT)
.IFNDEF EXT_PA
	ORA #BP16_PORT_D_BIT
.ENDIF
	TSB !BP1M
	TSB !BP1R
	TSB !BP1D	
.ENDIF
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	LDA #(SCLK_PORT_D_BIT+SDA_PORT_D_BIT)
	TSB !BP0M
	TSB !BP0R
	TSB !BP0D
	LDA #(BP12_PORT_D_BIT+BP13_PORT_D_BIT)
.IFNDEF EXT_PA
	ORA #BP17_PORT_D_BIT
.ENDIF
	TSB !BP1M
	TSB !BP1R
	TSB !BP1D	
	LDA #BP20_PORT_D_BIT
	TSB !BP2M
	TSB !BP2R
	TSB !BP2D	
.ENDIF

;.IF(PACKAGE_FORM = 'SOP8') 
;	LDA #00H
;.ENDIF
;.IF(PACKAGE_FORM = 'SOP14') 
.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
	LDA #(BP07_TYPE+BP13_TYPE+BP02_TYPE)
.IFNDEF EXT_PA
	ORA #BP06_TYPE
.ENDIF
.ENDIF

.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
	LDA #(BP17_TYPE+BP15_TYPE+BP02_TYPE)
.IFNDEF EXT_PA
	ORA #BP16_TYPE
.ENDIF
.ENDIF

.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	LDA #(BP12_TYPE+BP13_TYPE+BP20_TYPE)
.IFNDEF EXT_PA
	ORA #BP17_TYPE
.ENDIF
.ENDIF
;.ENDIF
	STA <IO_FLAG

	RESET_SCLK_SDA

	LDA #CMD_VALID
	STA <STATUS_FLAG

.IFDEF STANDBY_TIME	
	LDA #WITH_AUTO_SLEEP
	BEQ MAIN_START_INIT_NEXT1
	LDA #EN_STANDBY
	TSB <NUSP_FLAG1
.ENDIF

MAIN_START_INIT_NEXT1:
	LDA #80H
	STA <SP_VOLUME

	NSP_RESET_HWE_SETTING
	STZ !WAKEF
	CLI

.IF (POR_INDEX .EQ. 0)	
.ELSE
	STZ <RAM_BUFFER+2
	LDA #.HIGH.POR_INDEX		;H
	STA <PLAY_LIST_INDEX+1
	STA <RAM_BUFFER+1	;H
	LDA #.LOW.POR_INDEX
	STA <PLAY_LIST_INDEX
	STA <RAM_BUFFER	;L
	STZ <PLAY_TYPE
	JSR PLAY_CMD_PROCESS
.ENDIF
	JMP MAIN_LOOP

WAKE_UP_FROM_SLEEP:
	INIT_PA
.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
	LDA #C7H
	TSB !BP0M
	LDA #08H
	TSB !BP1M
.ENDIF
.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
	LDA #07H
	TSB !BP0M
	LDA #E0H
	TSB !BP1M
.ENDIF
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	LDA #03H
	TSB !BP0M
	LDA #8CH
	TSB !BP1M
	LDA #01H
	TSB !BP2M
.ENDIF	
	JSR RESTORE_LIB_DPD_RAM

;Configure CPU interface 	
	LDA #SCLK_PORT_D_BIT
	TSB !SCLK_PORT_D 
	LDA #SDA_PORT_D_BIT
	TSB !SDA_PORT_D
	LDA #SCLK_PORT_BIT
	TRB !SCLK_PORT_EN

.IF (WITH_ISP .EQ. 1)	
	JSR GET_ISP_SWAPPING_RAM
.ENDIF
	NSP_RESET_HWE_SETTING
	STZ !WAKEF
	CLI
;---------------------------SPEECH EQUATION -------------------------------------------------------------------------------
;	PLAY MANSPEAK_NSP<CH=1,VOL=128,SR=12000>
;		MANSPEAK_NSP is speech file name with NSP format
;		VOL=128 is volume level(0~128)
;		SR=12000 is sampling rate,
;		if user not assign value to SR then use the default S.R. in speech file
;---------------------------EVO EQUATION ---------------------------------------------------------------------------------
;	PLAY CLAP_1PIN<CH=EVO1,FORMAT=EVO>
;		CLAP_1PIN is file name with WIO format(speech with event or UIO command)
;		CH is evo channel assignment
;		if user not assign FORMAT then use the default EVO FORMAT(no audio data,only event and UIO command)
;-------------------------------------------------------------------------------------------------------------------------
MAIN_LOOP:
	LDA #WDTC_CLR
	STA !WDTC
	CLI
;-----------------------------------------
; Cap Sensor Detection looping
; If check touched will jmp to key label
;-----------------------------------------
	.IF(WITH_FW_CAP_SENSOR_KEYS .GT. 0)
	CAP_SENSOR_ACTION    
	CAP_SENSOR_KEY_DETECTION
	.ENDIF
;-----------------------------------------
	.IF (N55P_DEVICE_UIO_USED .GT. 0H)
		  N55P_EXPANDER_PROCESS
	.ENDIF


CHECK_START:
	LDA <NUSP_FLAG
	BIT #TX_DOING
	BEQ 3 
	JMP POLLING_TX

	LDA <NUSP_FLAG
	BIT #RX_DOING
	BEQ 3 
	JMP POLLING_RX

POLLING_SDA_CHANGE:
	LDA	!SDA_PORT
	AND	#SDA_PORT_BIT
	CMP <SDA_PREV
	BNE PARSE_SDA

	REFRESH_SCLK

.IFDEF STANDBY_TIME
	LDA <NUSP_FLAG1
	BIT #ENTER_STANDBY
	BEQ 3 
	JMP POLLING_STANDBY
.ENDIF
	JMP MAIN_LOOP_NEXT	

;SDA change when SCL=1
PARSE_SDA:
	STA <SDA_PREV

	LDA	!SCLK_PORT
	AND	#SCLK_PORT_BIT
	CMP <SCLK_PREV
	BEQ 5
	STA <SCLK_PREV
	JMP MAIN_LOOP

	LDA <SCLK_PREV
	BNE 3
	JMP MAIN_LOOP    ;SCL:0 error

	LDA <SDA_PREV
	BNE 3
	JMP POLLING_RX_START   	;SCL1£¬SDA 1->0
	JMP POLLING_TX_STOP		;SCL1£¬SDA 0->1
;==========================================
.IFDEF STANDBY_TIME
POLLING_STANDBY:
	LDA <NUSP_FLAG1
	BIT #LVD_DOING
	BNE POLLING_STANDBY_QUIT

	CHK_CH1_SENTENCE_BUSY
	BEQ POLLING_STANDBY_CHECK

POLLING_STANDBY_QUIT:
	LDA #ENTER_STANDBY
	TRB <NUSP_FLAG1
	CLEAR_STANDBY_RAM
	JMP MAIN_LOOP_NEXT

POLLING_STANDBY_CHECK:
	LDA <STANDBY_COUNT+1
	CMP #.HIGH.RX_STANDBY_COUNT
	BCS 3
	JMP MAIN_LOOP

	LDA <STANDBY_COUNT
	CMP #.LOW.RX_STANDBY_COUNT
	BCS 3
	JMP MAIN_LOOP
	LDA #00H
	JMP READ_SDA_PWR_DOWN_NEXT
.ENDIF	
;==========================================
MAIN_LOOP_NEXT:
	LDA #WDTC_CLR
	STA !WDTC

	CHK_CH1_SENTENCE_BUSY
	BEQ 3 
	JMP MAIN_LOOP

	LDA #SP_DOING
	BIT <NUSP_FLAG
	BNE 3
	JMP CHECK_SIL_DOING
	TRB <NUSP_FLAG

CHECK_PLAY_SIL_TODO:
	LDA <SIL_COUNT
	BNE 3
	JMP SIL_PLAY_FINISH
	LDA #SIL_DOING
	TSB <NUSP_FLAG
PLAY_SILENCE:
	LDA #WDTC_CLR
	STA !WDTC

;PLAY [10 msec]
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC
	PHP
	SEI

	LDA	#.LOW._@SIL_EQU
	STA HWE_CMD_BA+CMD_PARAMETER
	LDA	#.HIGH._@SIL_EQU
	STA HWE_CMD_BA+CMD_PARAMETER+1
	LDA	#.HIGH8._@SIL_EQU
	STA HWE_CMD_BA+CMD_PARAMETER+2
	.IF (WITH_SIM_SP .EQ. 1)
   	LDA	#.SEGHIGH._@SIL_EQU
	STA HWE_CMD_BA+CMD_PARAMETER+3
	.ELSE
	.ENDIF
	LDA #CMD_PLAY
	STA HWE_CMD_BA+CMD_IDX
	LDA #02H
	TSB !INTRF
	SET_SPEECH_BUSY_RT
	PLP
;JSR CHK_HANDSHAKE_PROC
	JMP MAIN_LOOP

CHECK_SIL_DOING:
	LDA #WDTC_CLR
	STA !WDTC	
	LDA #SIL_DOING
	BIT <NUSP_FLAG
	BNE 3 
	JMP MAIN_LOOP_CHECK

	DEC <SIL_COUNT
	BEQ 3 
	JMP PLAY_SILENCE

	LDA #SIL_DOING
	TRB <NUSP_FLAG

SIL_PLAY_FINISH:
	INC <EQU_INDEX
	LDA <EQU_INDEX
	CMP <EQU_COUNTER
	BEQ SIL_FINISH_CHECK_MULTI_PLAY

GET_SPEECH_SENTENCE_LIST:
	JSR GET_SPEECH_SENTENCE_PLAYLIST
	JMP MAIN_LOOP

SIL_FINISH_CHECK_MULTI_PLAY:
	LDA #MULTI_PLAY
	BIT <NUSP_FLAG
	BNE MULTI_PLAY_NEXT_INDEX

	LDA #PLAY_REPEAT
	BIT <NUSP_FLAG
	BEQ ALL_PLAY_FINISH

	LDA <PLAY_REPEAT_COUNT
	BEQ MAIN_LOOP_RELOAD_PLAYLIST_INDEX
	DEC <PLAY_REPEAT_COUNT
	BNE MAIN_LOOP_RELOAD_PLAYLIST_INDEX
	JMP ALL_PLAY_FINISH

MAIN_LOOP_RELOAD_PLAYLIST_INDEX:
	LDA #03H
	STA <PLAY_TYPE
	JSR RELOAD_PLAYLIST_INDEX
	BEQ ALL_PLAY_FINISH
	JMP MAIN_LOOP

MULTI_PLAY_NEXT_INDEX:
	INC <MULTI_PLAY_INDEX
	LDA <MULTI_PLAY_INDEX
	CMP <MULTI_PLAY_NUMBER
	BNE MULTI_PLAY_NEXT_INDEX_TODO

	LDA #PLAY_REPEAT
	BIT <NUSP_FLAG
	BEQ MULTI_PLAY_FINISH

	LDA <PLAY_REPEAT_COUNT
	BEQ MAIN_LOOP_RELOAD_MULTI_PLAYLIST_INDEX
	DEC <PLAY_REPEAT_COUNT
	BNE MAIN_LOOP_RELOAD_MULTI_PLAYLIST_INDEX
	JMP MULTI_PLAY_FINISH

MAIN_LOOP_RELOAD_MULTI_PLAYLIST_INDEX:
	LDA #03H
	STA <PLAY_TYPE
	JSR RELOAD_MULTI_PLAYLIST_INDEX
	BEQ MULTI_PLAY_FINISH
	JMP MAIN_LOOP

MULTI_PLAY_NEXT_INDEX_TODO:
	STZ <RAM_BUFFER+2
	LDA <MULTI_PLAY_INDEX	
	ASL A
	TAX	
	LDA MULTI_PLAY_BUFFER,X
	STA <RAM_BUFFER+1	;H
	LDA MULTI_PLAY_BUFFER+1,X
	STA <RAM_BUFFER	;L

	MULTI_PLAY_CHK_INDEX   MULTI_PLAY_NEXT_INDEX_TODO1,MULTI_PLAY_NEXT_INDEX_TODO,MULTI_PLAY_FINISH		
MULTI_PLAY_NEXT_INDEX_TODO1:
	LDA #03H
	STA <PLAY_TYPE

	JSR PLAY_CMD_PROCESS
	BEQ 3
	JMP MAIN_LOOP

MULTI_PLAY_FINISH:
ALL_PLAY_FINISH:
;equation play finish
	LDA #(SP_DOING+SIL_DOING+MULTI_PLAY+PLAY_REPEAT)
	TRB <NUSP_FLAG
	SP_FREE_PROC

MAIN_LOOP_PRE:
	LDA #SLEEP_AFTER
	BIT <NUSP_FLAG
	BEQ MAIN_LOOP_CHECK
	LDA #WDTC_CLR
	STA !WDTC
	LDA #00H
	JMP READ_SDA_PWR_DOWN_NEXT	

MAIN_LOOP_CHECK:
	SET_IDLE_FLAG
.IFDEF STANDBY_TIME	
	LDA #(SP_DOING+SIL_DOING+TX_DOING+RX_DOING)
	BIT <NUSP_FLAG
	BEQ 3
	JMP MAIN_LOOP

	LDA #(LVD_DOING+ENTER_STANDBY)
	BIT <NUSP_FLAG1
	BEQ 3
	JMP MAIN_LOOP

	LDA #EN_STANDBY
	BIT <NUSP_FLAG1
	BNE 3
	JMP MAIN_LOOP

	LDA #ENTER_STANDBY
	TSB <NUSP_FLAG1
	CLEAR_STANDBY_RAM
	SEI
	LDA #INT0_FXF15
	STA !EVF0
	TSB !IEF0
	CLI
	LDA #WDTC_CLR
	STA !WDTC
.ENDIF
	JMP MAIN_LOOP
;==========================================	
POLLING_RX_START:
;start:SDA 1->0 when SCL=1
	LDA #RX_DOING
	TSB <NUSP_FLAG

	STZ <RX_BYTE_COUNTER
	STZ <RX_BYTE_INDEX
	LDA #08H
	STA <RX_BIT_INDEX
	STZ <RX_CHKSUM
	LDA #01H
	STA <TX_BYTE_COUNTER

.IFDEF STANDBY_TIME
	LDA #EN_STANDBY
	BIT <NUSP_FLAG1
	BEQ POLLING_RX_START_NEXT

	LDA #ENTER_STANDBY
	TRB <NUSP_FLAG1
	CLEAR_STANDBY_RAM

POLLING_RX_START_NEXT:
.ENDIF	
	SEI
	STZ <TXRX_GAP
	LDA #INT0_FXF15
	STA !EVF0
	TSB !IEF0
	CLI
	JMP MAIN_LOOP
;-----------------------------------------	
POLLING_RX:
;SCL=1 read data
	LDA	!SCLK_PORT
	AND	#SCLK_PORT_BIT
	CMP <SCLK_PREV
	BNE PARSE_SCLK_RX
	JMP MAIN_LOOP

PARSE_SCLK_RX:
;SCL=1 read
	STA <SCLK_PREV
	LDA <SCLK_PREV
	BNE 3
	JMP MAIN_LOOP

	STZ <TXRX_GAP
	LDX <RX_BYTE_INDEX
	REFRESH_SDA
	BNE READ_1_FROM_SDA_PIN

READ_0_FROM_SDA_PIN:
	CLC
	BRA READ_FROM_SDA_PIN
READ_1_FROM_SDA_PIN:
	SEC
READ_FROM_SDA_PIN:
	ROL <RX_DATA,X
	DEC <RX_BIT_INDEX
	BEQ READ_FROM_SDA_PIN_NEXT_BYTE
	JMP MAIN_LOOP
;==========================================		
READ_FROM_SDA_PIN_NEXT_BYTE:
	LDA #08H
	STA <RX_BIT_INDEX

	CLC
	LDA <RX_DATA,X
	ADC <RX_CHKSUM
	STA <RX_CHKSUM

	LDA <RX_DATA_CMD
	CMP #CMD_ISP_WRITE_PAGE
	BNE 3
	JMP READ_NEXT_BYTE_ISPW
	CMP #CMD_ISP_WRITE_PARTIAL
	BNE 3
	JMP READ_NEXT_BYTE_ISPW
	CMP #CMD_MULTI_PLAY
	BNE 3
	JMP READ_NEXT_BYTE_MULTI_PLAY
	CMP #CMD_MULTI_PLAY_2B
	BNE 3
	JMP READ_NEXT_BYTE_MULTI_PLAY_2B
	INC <RX_BYTE_INDEX
	LDA <RX_BYTE_INDEX
	ASL A
	TAX
	JMP (READ_SDA_CHECK_TABLE,X)

READ_SDA_CHECK_1BCMD:
	LDA <RX_DATA
	CMP #CMD_ISP_WRITE_PAGE
	BEQ READ_SDA_CHECK_1BCMD_ISPW
	CMP #CMD_ISP_WRITE_PARTIAL
	BEQ READ_SDA_CHECK_1BCMD_ISPW
	JMP MAIN_LOOP

READ_SDA_CHECK_1BCMD_ISPW:
	LDA <RX_DATA
	STA <RX_DATA_CMD
	JMP MAIN_LOOP
;-----------------------------------------
READ_NEXT_BYTE_MULTI_PLAY:
;CMD_MULTI_PLAY:210 cycle
	LDX <RX_BYTE_INDEX
	CPX #03H
	BEQ READ_NEXT_BYTE_MULTI_PLAY_CHECKSUM

	LDX MULTI_PLAY_INDEX_RX
	STZ MULTI_PLAY_BUFFER_RX,X
	INC MULTI_PLAY_INDEX_RX
	BRA READ_NEXT_BYTE_MULTI_PLAY_NEXT
;-----------------------------------------
READ_NEXT_BYTE_MULTI_PLAY_2B:
	LDX <RX_BYTE_INDEX
	CPX #03H
	BEQ READ_NEXT_BYTE_MULTI_PLAY_CHECKSUM

READ_NEXT_BYTE_MULTI_PLAY_NEXT:
	LDX MULTI_PLAY_INDEX_RX
	LDA <RX_DATA+2
	STA MULTI_PLAY_BUFFER_RX,X
	INC MULTI_PLAY_INDEX_RX
	STZ <RX_DATA+2

	LDA MULTI_PLAY_NUMBER_RX
	ASL A
	CMP MULTI_PLAY_INDEX_RX
	BEQ READ_NEXT_BYTE_MULTI_PLAY_QUIT
	JMP MAIN_LOOP
READ_NEXT_BYTE_MULTI_PLAY_QUIT:
	INC <RX_BYTE_INDEX
	STZ MULTI_PLAY_INDEX_RX
	JMP MAIN_LOOP

READ_NEXT_BYTE_MULTI_PLAY_CHECKSUM:
	STZ <RX_DATA_CMD

	CMD_CHK_CHECKSUM

	LDA MULTI_PLAY_NUMBER_RX
	CMP #(MULTI_PLAY_NUMBER_MAX+1)
	BCC 3
	JMP READ_SDA_NOT_VALID
	LDA #.LOW.READ_SDA_MULTI_PLAY
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_MULTI_PLAY
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
;-----------------------------------------	
READ_NEXT_BYTE_ISPW:
;CMD_ISP_WRITE_PAGE:155 cycle
	LDA <RX_DATA_CMD
	CMP #CMD_ISP_WRITE_PAGE
	BEQ READ_NEXT_BYTE_ISPW_WRITE_PAGE
;CMP #CMD_ISP_WRITE_PARTIAL
;BEQ READ_NEXT_BYTE_ISPW_WRITE_PARTIAL

READ_NEXT_BYTE_ISPW_WRITE_PARTIAL:
	LDX <RX_BYTE_INDEX
	CPX #05H
	BEQ READ_NEXT_BYTE_ISPW_WRITE_PARTIAL_5B
	CPX #06H
	BCS READ_NEXT_BYTE_ISPW_WRITE_6B
	INC <RX_BYTE_INDEX
	JMP READ_NEXT_BYTE_ISPW_ADD

READ_NEXT_BYTE_ISPW_WRITE_PARTIAL_5B:
	LDA <RX_DATA+2
	AND #01H
	STA <ISP_LEN+1
	LDA <RX_DATA+3
	STA <ISP_LEN

	CLC
	LDA <RX_DATA+3
	ADC <RX_DATA+5
	STA <RAM_BUFFER
	LDA <RX_DATA+2
	ADC <RX_DATA+4
	STA <RAM_BUFFER+1
	LDA <RX_DATA+1
	ADC #00H
	STA <RAM_BUFFER+2

	CLC
	LDA <ISP_LEN
	ADC <RX_DATA+5
	STA <ISP_LEN_COUNT
	LDA <ISP_LEN+1
	ADC <RX_DATA+4
	STA <ISP_LEN_COUNT+1	

	LDA #06H
	STA <RX_BYTE_INDEX
	JMP READ_NEXT_BYTE_ISPW_ADD

READ_NEXT_BYTE_ISPW_WRITE_PAGE:
	LDX <RX_BYTE_INDEX
	CPX #03H
	BEQ READ_NEXT_BYTE_ISPW_WRITE_PAGE_3B
	CPX #06H
	BCS READ_NEXT_BYTE_ISPW_WRITE_6B_NEXT
	INC <RX_BYTE_INDEX
	JMP READ_NEXT_BYTE_ISPW_ADD

READ_NEXT_BYTE_ISPW_WRITE_PAGE_3B:
	CLC
	LDA <RX_DATA+3
	ADC #.LOW.ISP_WRITE_PAGE_SIZE
	STA <RAM_BUFFER
	LDA <RX_DATA+2
	ADC #.HIGH.ISP_WRITE_PAGE_SIZE
	STA <RAM_BUFFER+1
	LDA <RX_DATA+1
	ADC #00H
	STA <RAM_BUFFER+2

	STZ <ISP_LEN
	STZ <ISP_LEN+1
	LDA #06H
	STA <RX_BYTE_INDEX
	JMP READ_NEXT_BYTE_ISPW_ADD

READ_NEXT_BYTE_ISPW_WRITE_6B:
	LDA <ISP_LEN
	CMP <ISP_LEN_COUNT
	BNE READ_NEXT_BYTE_ISPW_WRITE_6B_NEXT
	LDA <ISP_LEN+1
	CMP <ISP_LEN_COUNT+1
	BEQ READ_NEXT_BYTE_ISPW_CHECKSUM

READ_NEXT_BYTE_ISPW_WRITE_6B_NEXT:
	LDX <ISP_LEN
	LDA <ISP_LEN+1
	BEQ READ_NEXT_BYTE_ISPW_LESS_THAN_256
	CMP #01H
	BEQ READ_NEXT_BYTE_ISPW_MORE_THAN_256
	CMP #.HIGH.ISP_WRITE_PAGE_SIZE
	BEQ READ_NEXT_BYTE_ISPW_CHECKSUM

READ_NEXT_BYTE_ISPW_LESS_THAN_256:
.IF (WITH_ISP .EQ. 1)
	LDA <RX_DATA+6
	STA ISP_WRITE_PAGE_BUFFER,X
.ENDIF
	BRA READ_NEXT_BYTE_ISPW_INC	
READ_NEXT_BYTE_ISPW_MORE_THAN_256:
.IF (WITH_ISP .EQ. 1)
	LDA <RX_DATA+6
	STA ISP_WRITE_PAGE_BUFFER+100H,X
.ENDIF

READ_NEXT_BYTE_ISPW_INC:
	INC <ISP_LEN
	BNE 2
	INC <ISP_LEN+1

READ_NEXT_BYTE_ISPW_ADD:
	JMP MAIN_LOOP

READ_NEXT_BYTE_ISPW_CHECKSUM:
.IF (WITH_ISP .EQ. 1)
	LDA <RX_CHKSUM
	CMP #FFH
	BEQ 5
	STZ <RX_DATA_CMD
	JMP READ_SDA_NOT_VALID

	LDA <RX_DATA_CMD
	CMP #CMD_ISP_WRITE_PAGE
	BNE READ_NEXT_BYTE_ISPW_CHECK

	LDA <RX_DATA+3
	BEQ 3
	JMP READ_SDA_NOT_VALID
	LDA <RX_DATA+2
	BIT #01H
	BEQ 3
	JMP READ_SDA_NOT_VALID
	LDA #.LOW.READ_SDA_ISP_WRITE_PAGE
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_WRITE_PAGE
	STA <CMD_JUMP+1
	STZ <RX_DATA_CMD
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO

READ_NEXT_BYTE_ISPW_CHECK:
	CMP #CMD_ISP_WRITE_PARTIAL
	BNE READ_NEXT_BYTE_ISPW_CHECK_ERROR
	LDA #.LOW.READ_SDA_ISP_WRITE_PARTIAL
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_WRITE_PARTIAL
	STA <CMD_JUMP+1
	STZ <RX_DATA_CMD
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO
READ_NEXT_BYTE_ISPW_CHECK_ERROR:
	STZ <RX_DATA_CMD
	JMP READ_SDA_NOT_VALID	
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF
;-----------------------------------------	
;-----------------------------------------
READ_SDA_CHECK_2BCMD:
	LDA <RX_DATA			;2
	AND #0FH			;2
	ASL A				;2
	TAX				;2
	LDA <RX_DATA			;2
	AND #F0H			;2

	CMP #70H			;2
	BNE 3				;2~3
	JMP (TWO_WIRE_CMD_TABLE_2B_7,X)	;6;5/10	
	CMP #80H			;2
	BNE 3				;2~3
	JMP (TWO_WIRE_CMD_TABLE_2B_8,X)	;6;5/10
	CMP #10H			;2
	BNE 3				;2~3
	JMP (TWO_WIRE_CMD_TABLE_2B_1,X)	;6;5/10
	CMP #F0H			;2
	BNE 3				;2~3
	JMP (TWO_WIRE_CMD_TABLE_2B_F,X)	;6;5/10
	CMP #D0H			;2
	BNE 3				;2~3
	JMP (TWO_WIRE_CMD_TABLE_2B_D,X)	;6;5/10
	JMP READ_SDA_NOT_VALID

READ_SDA_DO_LVD_2B:
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_DO_LVD
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_DO_LVD
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_DO_CHECKSUM_2B:
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_DO_CHECKSUM
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_DO_CHECKSUM
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_PAUSE_2B:
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	CMD_CHK_CHECKSUM

	LDA <NUSP_FLAG
	BIT #SLEEP_AFTER
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
	BIT #(SP_DOING+SIL_DOING)
	BNE 3
	JMP READ_SDA_UNSUPPORTED

	LDA #.LOW.READ_SDA_PAUSE
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_PAUSE
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF

READ_SDA_RESUME_2B:
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	CMD_CHK_CHECKSUM

	LDA <NUSP_FLAG
	BIT #PLAY_PAUSE
	BNE 3
	JMP READ_SDA_UNSUPPORTED

	LDA #.LOW.READ_SDA_RESUME
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_RESUME
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF

READ_SDA_STOP_EQU_2B:
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_STOP_EQU
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_STOP_EQU
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_PWR_RESET_2B:
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_PWR_RESET
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_PWR_RESET
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_PWR_DOWN_2B:
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_PWR_DOWN
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_PWR_DOWN
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_SPBZOUT_EN_2B:
.IF(PACKAGE_FORM = 'SOP8')
	JMP READ_SDA_UNSUPPORTED
.ENDIF
.IF(PACKAGE_FORM = 'SOP14')
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_SPBZOUT_EN
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_SPBZOUT_EN
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
.ENDIF

READ_SDA_SPBZOUT_DIS_2B:
.IF(PACKAGE_FORM = 'SOP8')
	JMP READ_SDA_UNSUPPORTED
.ENDIF
.IF(PACKAGE_FORM = 'SOP14')	
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_SPBZOUT_DIS
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_SPBZOUT_DIS
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
.ENDIF

READ_SDA_ISP_WRITE_PARTIAL_START_2B:
.IF (WITH_ISP .EQ. 1)
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_ISP_WRITE_PARTIAL_START
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_WRITE_PARTIAL_START
	STA <CMD_JUMP+1
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF

READ_SDA_ISP_WRITE_END_2B:
.IF (WITH_ISP .EQ. 1)	
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_ISP_WRITE_END
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_WRITE_END
	STA <CMD_JUMP+1
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF
;-----------------------------------------
READ_SDA_CHECK_CMD_MULTI_PLAY:
	LDA <RX_DATA
	STA <RX_DATA_CMD
	LDA <RX_DATA+1
	STA MULTI_PLAY_NUMBER_RX
	STZ MULTI_PLAY_INDEX_RX
	JMP MAIN_LOOP
;-----------------------------------------	    
READ_SDA_READ_ID:
	CMD_CHK_CHECKSUM	
	LDA <ID_RAM
	STA <TX_DATA
	LDA <ID_RAM+1
	STA <TX_DATA+1
	LDA <ID_RAM+2
	STA <TX_DATA+2
	LDA <ID_RAM+3
	STA <TX_DATA+3
	CLC
	LDA <TX_DATA
	ADC <TX_DATA+1
	CLC
	ADC <TX_DATA+2
	CLC
	ADC <TX_DATA+3
	EOR #FFH
	STA <TX_DATA+4

	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #5H
	JMP CHANGE_TO_TX
;-----------------------------------------
READ_SDA_READ_STATUS:
	CMD_CHK_CHECKSUM	
	LDA <STATUS_FLAG
	STA <TX_DATA
	JMP CHANGE_TO_2B_TX
;-----------------------------------------	
READ_SDA_READ_IO_TYPE:
	CMD_CHK_CHECKSUM
.IF(PACKAGE_FORM = 'SOP8')
	LDA #UNSUPPORTED_RTN
.ELSE
	LDA <IO_FLAG
.ENDIF
	STA <TX_DATA   
	JMP CHANGE_TO_2B_TX
;-----------------------------------------	
READ_SDA_READ_GET_INOUT:
	CMD_CHK_CHECKSUM
.IF(PACKAGE_FORM = 'SOP8')
	LDA #UNSUPPORTED_RTN
	STA <TX_DATA
.ELSE
.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
	LDA #(BP07_PORT_BIT+BP06_PORT_BIT+BP02_PORT_BIT)
	AND !BP0R
	STA <TX_DATA
	LDA #BP13_PORT_BIT
	AND !BP1R
	ORA <TX_DATA
	STA <TX_DATA
.ENDIF
.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
	LDA #(BP17_PORT_BIT+BP16_PORT_BIT+BP15_PORT_BIT)
	AND !BP1R
	STA <TX_DATA
	LDA #BP02_PORT_BIT
	AND !BP0R
	ORA <TX_DATA
	STA <TX_DATA
.ENDIF
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	LDA #(BP17_PORT_BIT+BP13_PORT_BIT+BP12_PORT_BIT)
	AND !BP1R
	STA <TX_DATA
	LDA #BP20_PORT_BIT
	AND !BP2R
	ORA <TX_DATA
	STA <TX_DATA
.ENDIF
.ENDIF 	
	JMP CHANGE_TO_2B_TX
;-----------------------------------------
READ_SDA_GET_INDEX_RCOUNT:
	CMD_CHK_CHECKSUM
	LDA RESOURCE_COUNT
	STA <TX_DATA
	JMP CHANGE_TO_2B_TX
;-----------------------------------------	
READ_SDA_READ_GET_VOL:
	CMD_CHK_CHECKSUM
	LDA <SP_VOLUME
	STA <TX_DATA
	JMP CHANGE_TO_2B_TX
;-----------------------------------------	
READ_SDA_GET_LVD:
	CMD_CHK_CHECKSUM
	LDA <LVD_VALUE
	STA <TX_DATA
	JMP CHANGE_TO_2B_TX
;-----------------------------------------
READ_SDA_CHECKSUM_RIGHT:
	CMD_CHK_CHECKSUM
	LDA CHECKSUM_BYTE+2
	STA <TX_DATA
	JMP CHANGE_TO_2B_TX
;-----------------------------------------
READ_SDA_GET_CHECKSUM:
	CMD_CHK_CHECKSUM
	LDA CHECKSUM_BYTE+1
	STA <TX_DATA
	LDA CHECKSUM_BYTE
	STA <TX_DATA+1
READ_SDA_GET_CHECKSUM_NEXT:
	CLC
	LDA <TX_DATA
	ADC <TX_DATA+1
	EOR #FFH
	STA <TX_DATA+2

	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #3H
	JMP CHANGE_TO_TX
;-----------------------------------------
READ_SDA_ISP_CHECKSUM:
.IF (WITH_ISP .EQ. 1)
	CMD_CHK_CHECKSUM
	LDA <ISP_CHECKSUM_BYTE+1
	STA <TX_DATA
	LDA <ISP_CHECKSUM_BYTE
	STA <TX_DATA+1
	BRA READ_SDA_GET_CHECKSUM_NEXT
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF
;-----------------------------------------	
READ_SDA_GET_FW_VERSION:
	CMD_CHK_CHECKSUM
	LDA #.HIGH8.FW_VERSION
	STA <TX_DATA
	LDA #.HIGH.FW_VERSION
	STA <TX_DATA+1
	LDA #.LOW.FW_VERSION
	STA <TX_DATA+2
	CLC
	LDA <TX_DATA
	ADC <TX_DATA+1
	CLC
	ADC <TX_DATA+2
	EOR #FFH
	STA <TX_DATA+3

	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #4H
	JMP CHANGE_TO_TX
;-----------------------------------------	
READ_SDA_READ_STOP_REPEAT:
	CMD_CHK_CHECKSUM
	LDA <NUSP_FLAG
	BIT #(SP_DOING+SIL_DOING)
	BNE 3
	JMP READ_SDA_NOT_VALID

	LDA #PLAY_REPEAT
	BIT <NUSP_FLAG
	BNE 3
	JMP READ_SDA_NOT_VALID
	TRB <NUSP_FLAG	
	LDA #01H
	STA <PLAY_REPEAT_COUNT
	JMP READ_SDA_SUCCESS_DONE
;-----------------------------------------
READ_SDA_AUTO_SLEEP_EN:
.IFDEF STANDBY_TIME
	CMD_CHK_CHECKSUM
	LDA #EN_STANDBY
	TSB <NUSP_FLAG1
	JMP READ_SDA_SUCCESS_DONE
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF
;-----------------------------------------
READ_SDA_AUTO_SLEEP_DIS:
.IFDEF STANDBY_TIME
	CMD_CHK_CHECKSUM
	LDA #(EN_STANDBY+ENTER_STANDBY)
	TRB <NUSP_FLAG1
	CLEAR_STANDBY_RAM
	JMP READ_SDA_SUCCESS_DONE
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF
;-----------------------------------------	
CHANGE_TO_2B_TX:
	LDA #CMD_VALID
	TSB <STATUS_FLAG

	LDA <TX_DATA
	EOR #FFH
	STA <TX_DATA+1
	LDA #2H
	JMP CHANGE_TO_TX	
;-----------------------------------------
;-----------------------------------------	
READ_SDA_CHECK_3BCMD:
;CMD_SET_OUT:264 cycle
	LDA <RX_DATA
	CMP #CMD_REPEAT
	BNE 3
	JMP READ_SDA_REPEAT
	CMP #CMD_SET_VOL_NSP
	BNE READ_SDA_CHECK_3BCMD_NEXT
	CMD_CHK_CHECKSUM
	LDA <RX_DATA+1		;H
	CMP #80H
	BCC 5
	BEQ 3
	JMP READ_SDA_NOT_VALID	
	LDA #.LOW.READ_SDA_SET_VOL
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_SET_VOL
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_CHECK_3BCMD_NEXT:
	CMP #CMD_IO_CONFIG
.IF(PACKAGE_FORM = 'SOP8')
	BNE 3
	JMP READ_SDA_UNSUPPORTED
.ENDIF
.IF(PACKAGE_FORM = 'SOP14')
	BNE 20
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_SET_IO_CONFIG
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_SET_IO_CONFIG
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
.ENDIF

	CMP #CMD_SET_OUT
.IF(PACKAGE_FORM = 'SOP8')
	BNE 3
	JMP READ_SDA_UNSUPPORTED
.ENDIF
.IF(PACKAGE_FORM = 'SOP14')
	BNE 20
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_SET_OUT
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_SET_OUT
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
.ENDIF

	LDA <RX_DATA
	CMP #CMD_PLAY_EQU
	BNE 3
	JMP MAIN_LOOP
	CMP #CMD_PLAY_SLEEP		;play >IO
	BNE 3
	JMP MAIN_LOOP
	CMP #CMD_ISP_READ_RES_INDEX
	BNE 3
	JMP MAIN_LOOP
	CMP #CMD_CHECK_INDEX_RCOUNT
	BNE 3
	JMP MAIN_LOOP

READ_SDA_CHECK_4BCMD_NEXT:
	CMP #CMD_ISP_WRITE_PARTIAL_BAK
	BNE 3
	JMP MAIN_LOOP
	CMP #CMD_ISP_READ_PAGE
	BNE 3
	JMP MAIN_LOOP

READ_SDA_CHECK_5BCMD_NEXT:
	CMP #CMD_ISP_READ_PARTIAL
	BNE 3
	JMP MAIN_LOOP

READ_SDA_CHECK_7BCMD_NEXT:
	CMP #CMD_ISP_WRITE_START
	BNE 3
	JMP MAIN_LOOP

READ_SDA_CHECK_8BCMD_NEXT:
	CMP #CMD_MULTI_PLAY
	BNE 3
	JMP MAIN_LOOP
	CMP #CMD_MULTI_PLAY_2B
	BNE 3
	JMP MAIN_LOOP
	CMP #CMD_ISP_WRITE_PAGE
	BNE 3
	JMP MAIN_LOOP	
	CMP #CMD_ISP_WRITE_PARTIAL
	BNE 3
	JMP MAIN_LOOP
	JMP READ_SDA_NOT_VALID
;-----------------------------------------	
READ_SDA_REPEAT:
	CMD_CHK_CHECKSUM
	LDA <NUSP_FLAG
	BIT #(SP_DOING+SIL_DOING)
	BNE 3
	JMP READ_SDA_NOT_VALID

	LDA <RX_DATA+1
	STA <PLAY_REPEAT_COUNT
	LDA #PLAY_REPEAT
	TSB <NUSP_FLAG
	JMP READ_SDA_SUCCESS_DONE
;-----------------------------------------	
;-----------------------------------------
READ_SDA_CHECK_4BCMD:
;CMD_PLAY_EQU:291 cycle
	LDA <RX_DATA
	CMP #CMD_ISP_READ_RES_INDEX
	BEQ READ_4BCMD_ISP_READ_RES_INDEX
	JMP READ_SDA_READ_PLAY

READ_4BCMD_ISP_READ_RES_INDEX:
	CMD_CHK_CHECKSUM
	CLC
	LDA <RX_DATA+2
	ADC #.LOW.SYSTEM_EQU_COUNT
	STA <RX_DATA+2
	LDA <RX_DATA+1
	ADC #.HIGH.SYSTEM_EQU_COUNT
	STA <RX_DATA+1

	LDA <RX_DATA+1
	ORA <RX_DATA+2
	BNE 3
	JMP ISP_READ_RES_INDEX_OUT_RANGE

	LDA <RX_DATA+1		;H
	CMP #.HIGH.MAX_RESOURCE_NUM
	BCC READ_SDA_CHECK_4BCMD_RES_NEXT
	BEQ READ_SDA_CHECK_4BCMD_RES_CHK
	JMP ISP_READ_RES_INDEX_OUT_RANGE

READ_SDA_CHECK_4BCMD_RES_CHK:
	LDA <RX_DATA+2			;;L
	CMP #.LOW.MAX_RESOURCE_NUM	;; L
	BCC READ_SDA_CHECK_4BCMD_RES_NEXT	;;<
	BEQ READ_SDA_CHECK_4BCMD_RES_NEXT	;;=

ISP_READ_RES_INDEX_OUT_RANGE:
	LDX #FFH
ISP_READ_RES_INDEX_OUT_RANGE_LOOP:
	INX
	STZ ISP_PARTIAL_HEAD_PAGE_RAM,X
	CPX #0EH
	BCC ISP_READ_RES_INDEX_OUT_RANGE_LOOP
	STZ ISP_PARTIAL_REAL_SIZE_RAM
	STZ ISP_PARTIAL_REAL_SIZE_RAM+1
	STZ ISP_PARTIAL_REAL_SIZE_RAM+2
	JMP READ_SDA_NOT_VALID

READ_SDA_CHECK_4BCMD_RES_NEXT:
	LDA #.LOW.READ_SDA_ISP_READ_RES_INDEX
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_READ_RES_INDEX
	STA <CMD_JUMP+1
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO

READ_SDA_READ_PLAY:
	LDA <RX_DATA
	CMP #CMD_PLAY_EQU
	BEQ READ_SDA_READ_PLAY1
	CMP #CMD_CHECK_INDEX_RCOUNT
	BEQ READ_SDA_READ_PLAY2
	CMP #CMD_PLAY_SLEEP
	BEQ 3
	JMP READ_SDA_CHECK_4BCMD_NEXT	
	CHK_CONTINUE_PLAY_UNSUPPORTED
	BRA READ_SDA_READ_PLAY1

READ_SDA_READ_PLAY2:
	STZ RESOURCE_COUNT	
READ_SDA_READ_PLAY1:
	CMD_CHK_CHECKSUM	
	LDA <RX_DATA+1
	ORA <RX_DATA+2
	BNE 3
	JMP READ_SDA_NOT_VALID

	LDA <RX_DATA+1		;H
	CMP <PLAY_LIST_COUNT+1	;;H 
	BCC READ_SDA_READ_PLAY1_NEXT
	BEQ READ_SDA_CHECK_4BCMD_CHK
	JMP READ_SDA_NOT_VALID

READ_SDA_CHECK_4BCMD_CHK:
	LDA <RX_DATA+2			;;L
	CMP <PLAY_LIST_COUNT	;; L
	BCC READ_SDA_READ_PLAY1_NEXT	;;<
	BEQ READ_SDA_READ_PLAY1_NEXT	;;=
	JMP READ_SDA_NOT_VALID

READ_SDA_READ_PLAY1_NEXT:
	LDA <RX_DATA
	CMP #CMD_CHECK_INDEX_RCOUNT
	BEQ READ_4BCMD_CHECK_INDEX_RCOUNT
	CMP #CMD_PLAY_EQU
	BEQ READ_SDA_PLAY_NOT_SLEEP
	CMP #CMD_PLAY_SLEEP
	BEQ READ_SDA_SLEEP_AFTER_PLAY
	JMP READ_SDA_NOT_VALID

READ_4BCMD_CHECK_INDEX_RCOUNT:
	LDA #04H
	STA <PLAY_TYPE
	BRA READ_SDA_CHECK_4BCMD_PLAY

READ_SDA_SLEEP_AFTER_PLAY:
	LDA #01H
	STA <PLAY_TYPE
	BRA READ_SDA_CHECK_4BCMD_PLAY

READ_SDA_PLAY_NOT_SLEEP:
	STZ <PLAY_TYPE

READ_SDA_CHECK_4BCMD_PLAY:
	LDA #.LOW.READ_SDA_PLAY
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_PLAY
	STA <CMD_JUMP+1
	JMP READ_SDA_SUCCESS_UNDO
;-----------------------------------------	
;-----------------------------------------
READ_SDA_CHECK_5BCMD:
;CMD_ISP_READ_PAGE:269 cycle+20us
	LDA <RX_DATA
	CMP #CMD_ISP_READ_PAGE
	BEQ READ_SDA_READ_ISP_READ_PAGE
	CMP #CMD_ISP_WRITE_PARTIAL_BAK
	BEQ 3
	JMP READ_SDA_CHECK_5BCMD_NEXT

.IF (WITH_ISP .EQ. 1)	
	CMD_CHK_CHECKSUM
	LDA #.LOW.READ_SDA_ISP_WRITE_PARTIAL_BAK
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_WRITE_PARTIAL_BAK
	STA <CMD_JUMP+1
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF

READ_SDA_READ_ISP_READ_PAGE:
	CMD_CHK_CHECKSUM
	LDA <RX_DATA+3
	BEQ 3
	JMP READ_SDA_NOT_VALID
	LDA <RX_DATA+2
	BIT #01H
	BEQ 3
	JMP READ_SDA_NOT_VALID

	LDA #CMD_ISP_READ_PAGE
	STA <RX_DATA_CMD
	STZ <ISP_LEN_READ
	LDA #02H
	STA <ISP_LEN_READ+1

	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	LDA <RX_DATA+1
	STA <ISP_ADDR_RAM+2
	LDA <RX_DATA+2
	STA <ISP_ADDR_RAM+1
	LDA <RX_DATA+3
	STA <ISP_ADDR_RAM
	FLASH_READ_RAM ISP_ADDR_RAM,ISP_LEN,TX_DATA
	CLC
	LDA <ISP_ADDR_RAM
	ADC <ISP_LEN
	STA <ISP_ADDR_RAM
	LDA <ISP_ADDR_RAM+1
	ADC #00H
	STA <ISP_ADDR_RAM+1
	LDA <ISP_ADDR_RAM+2
	ADC #00H
	STA <ISP_ADDR_RAM+2

	CLC
	LDA <TX_DATA
	ADC <TX_DATA+1
	CLC
	ADC <TX_DATA+2
	CLC
	ADC <TX_DATA+3
	STA <TX_DATA+4
	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #5H
	JMP CHANGE_TO_TX
;-----------------------------------------	
;-----------------------------------------
READ_SDA_CHECK_7BCMD:
	LDA <RX_DATA
	CMP #CMD_ISP_READ_PARTIAL
	BEQ 3
	JMP READ_SDA_CHECK_7BCMD_NEXT

	CMD_CHK_CHECKSUM
	LDA <RX_DATA+4
	ORA <RX_DATA+5
	BNE 3
	JMP READ_SDA_NOT_VALID

READ_SDA_READ_ISP_READ_PARTIAL:
	LDA #CMD_ISP_READ_PARTIAL
	STA <RX_DATA_CMD

	LDA <RX_DATA+1
	STA <ISP_ADDR_RAM+2
	LDA <RX_DATA+2
	STA <ISP_ADDR_RAM+1
	LDA <RX_DATA+3
	AND #FCH
	STA <ISP_ADDR_RAM
	LDA <RX_DATA+5
	STA <ISP_LEN_READ
	LDA <RX_DATA+4
	STA <ISP_LEN_READ+1

	LDA <RX_DATA+4
	BNE ISP_READ_PARTIAL_GT4
	CLC
	LDA <RX_DATA+3
	AND #03H
	ADC <RX_DATA+5
	CMP #04H
	BCS ISP_READ_PARTIAL_GT4
	BRA 2
ISP_READ_PARTIAL_GT4:
	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1

	FLASH_READ_RAM ISP_ADDR_RAM,ISP_LEN,TX_DATA

	LDA <RX_DATA+3
	AND #03H
	BEQ READ_SDA_ISP_READ_PARTIAL_START0
	CMP #01H
	BEQ READ_SDA_ISP_READ_PARTIAL_START1
	CMP #02H
	BEQ READ_SDA_ISP_READ_PARTIAL_START2
	JMP READ_SDA_ISP_READ_PARTIAL_START3

READ_SDA_ISP_READ_PARTIAL_START0:
	CLC
	LDA <TX_DATA
	ADC <TX_DATA+1
	CLC
	ADC <TX_DATA+2
	CLC
	ADC <TX_DATA+3
	STA <TX_DATA+4
	STZ <TX_BYTE_INDEX
	JMP READ_SDA_ISP_READ_PARTIAL_NEXT

READ_SDA_ISP_READ_PARTIAL_START1:
	CLC
	LDA <TX_DATA+1
	ADC <TX_DATA+2
	CLC
	ADC <TX_DATA+3
	STA <TX_DATA+4
	LDA #01H
	STA <TX_BYTE_INDEX
	JMP READ_SDA_ISP_READ_PARTIAL_NEXT

READ_SDA_ISP_READ_PARTIAL_START2:
	CLC
	LDA <TX_DATA+2
	ADC <TX_DATA+3
	STA <TX_DATA+4
	LDA #02H
	STA <TX_BYTE_INDEX
	JMP READ_SDA_ISP_READ_PARTIAL_NEXT

READ_SDA_ISP_READ_PARTIAL_START3:
	LDA <TX_DATA+3
	STA <TX_DATA+4
	LDA #03H
	STA <TX_BYTE_INDEX
	JMP READ_SDA_ISP_READ_PARTIAL_NEXT

READ_SDA_ISP_READ_PARTIAL_NEXT:
	CLC
	LDA <ISP_ADDR_RAM
	ADC <ISP_LEN
	STA <ISP_ADDR_RAM
	LDA <ISP_ADDR_RAM+1
	ADC #00H
	STA <ISP_ADDR_RAM+1
	LDA <ISP_ADDR_RAM+2
	ADC #00H
	STA <ISP_ADDR_RAM+2

	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #5H
	STA <TX_BYTE_COUNTER
;STZ <TX_BIT_INDEX
	JMP CHANGE_TO_TX_NEXT
;-----------------------------------------	
;-----------------------------------------
READ_SDA_CHECK_8BCMD:
;CMD_ISP_WRITE_START: 333 cycle
	LDA <RX_DATA
	CMP #CMD_ISP_WRITE_START
	BEQ 3
	JMP READ_SDA_CHECK_8BCMD_NEXT

.IF (WITH_ISP .EQ. 1)	
	CMD_CHK_CHECKSUM
	LDA <RX_DATA+1
	CMP <ID_RAM
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
	LDA <RX_DATA+2
	CMP <ID_RAM+1
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
	LDA !CHIP_PDID_ADDR
	CMP <RX_DATA+3
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
	LDA !CHIP_PDID_ADDR-1
	CMP <RX_DATA+4
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
	LDA !CHIP_PDID_ADDR-2
	CMP <RX_DATA+5
	BEQ 3
	JMP READ_SDA_UNSUPPORTED
	LDA !CHIP_PDID_ADDR-3
	CMP <RX_DATA+6
	BEQ 3
	JMP READ_SDA_UNSUPPORTED

	LDA #.LOW.READ_SDA_ISP_WRITE_START
	STA <CMD_JUMP
	LDA #.HIGH.READ_SDA_ISP_WRITE_START
	STA <CMD_JUMP+1
	SET_SDA_OUT0_FLAG
	JMP READ_SDA_SUCCESS_UNDO
.ELSE
	JMP READ_SDA_UNSUPPORTED
.ENDIF
;-----------------------------------------	
;-----------------------------------------		
READ_SDA_SUCCESS_UNDO:
	LDA #CMD_UNDO
	TSB <NUSP_FLAG1
READ_SDA_SUCCESS_DONE:
	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #RIGHT_RTN
	BRA READ_SDA_TO_TX

READ_SDA_UNSUPPORTED:
	LDA #CMD_VALID
	TRB <STATUS_FLAG
	LDA #UNSUPPORTED_RTN
	BRA READ_SDA_TO_TX

READ_SDA_NOT_VALID:
	LDA #CMD_VALID
	TRB <STATUS_FLAG
	LDA #ERROR_RTN
READ_SDA_TO_TX:
	STA <TX_DATA
	LDA #01H
	BRA CHANGE_TO_TX	
;==========================================			
CHANGE_TO_TX:
	STA <TX_BYTE_COUNTER
	STZ <TX_BYTE_INDEX
;STZ <TX_BIT_INDEX

CHANGE_TO_TX_NEXT:
	LDY #08H	
	LDA #TX_DOING
	TSB <NUSP_FLAG
	LDA #RX_DOING
	TRB <NUSP_FLAG	

;SDA:input->output
	LDA #SDA_TX
	TSB <NUSP_FLAG1
	JMP MAIN_LOOP
;==========================================
POLLING_TX:
	LDA !SCLK_PORT
	AND #SCLK_PORT_BIT
	CMP <SCLK_PREV
	BNE PARSE_SCLK_TX
	JMP MAIN_LOOP

PARSE_SCLK_TX:
;SCL=0 write
	STA <SCLK_PREV
	LDA <SCLK_PREV
	BEQ 3
	JMP MAIN_LOOP

	STZ <TXRX_GAP
	LDX <TX_BYTE_INDEX
	CPX <TX_BYTE_COUNTER
	BNE 3
	JMP SEND_TO_SDA_PIN_FINISH

	ASL <TX_DATA,X
	BCS SEND_1_TO_SDA_PIN

SEND_0_TO_SDA_PIN:
	LDA #SDA_PORT_BIT
	TRB !SDA_PORT
	STZ <SDA_PREV
	BRA SEND_TO_SDA_PIN_CONST

SEND_1_TO_SDA_PIN:
	LDA #SDA_PORT_BIT
	TSB !SDA_PORT
	STA <SDA_PREV

SEND_TO_SDA_PIN_CONST:
;INC <TX_BIT_INDEX
;LDA <TX_BIT_INDEX
;CMP #08H
	LDA #SDA_TX
	BIT <NUSP_FLAG1
	BEQ SEND_TO_SDA_PIN_CONST_NEXT
	TRB <NUSP_FLAG1
	LDA #SDA_PORT_D_BIT	;12/23
	TRB !SDA_PORT_D		;12/23	
SEND_TO_SDA_PIN_CONST_NEXT:
	DEY
	BEQ SEND_TO_SDA_PIN_NEXT_BYTE
	JMP MAIN_LOOP

SEND_TO_SDA_PIN_NEXT_BYTE:
;STZ <TX_BIT_INDEX
	LDY #08H
	INC <TX_BYTE_INDEX

	LDA <RX_DATA_CMD
	CMP #CMD_ISP_READ_PAGE
	BEQ SEND_TO_SDA_PIN_NEXT_BYTE_ISP_READ	
	CMP #CMD_ISP_READ_PARTIAL
	BEQ SEND_TO_SDA_PIN_NEXT_BYTE_ISP_READ
	JMP MAIN_LOOP

SEND_TO_SDA_PIN_NEXT_BYTE_ISP_READ:
	SEC
	LDA <ISP_LEN_READ
	SBC #01H
	STA <ISP_LEN_READ
	LDA <ISP_LEN_READ+1
	SBC #00H
	STA <ISP_LEN_READ+1
	ORA <ISP_LEN_READ
	BNE SEND_TO_SDA_PIN_NEXT_BYTE_ISPR_CHECK

	LDA <TX_DATA+4
	EOR #FFH
	STA <TX_DATA+4
	STZ <RX_DATA_CMD

	LDA <TX_BYTE_COUNTER
	DEC A
	STA <TX_BYTE_INDEX
	JMP MAIN_LOOP

SEND_TO_SDA_PIN_NEXT_BYTE_ISPR_CHECK:
	LDA <TX_BYTE_INDEX
	CMP #04H
	BEQ 3
	JMP MAIN_LOOP

	LDA <ISP_LEN_READ+1
	BNE SEND_TX_NEXT_BYTE_ISPR_GT4
	LDA <ISP_LEN_READ
	CMP #04H
	BCS SEND_TX_NEXT_BYTE_ISPR_GT4
	LDA <ISP_LEN_READ
	BRA 2
SEND_TX_NEXT_BYTE_ISPR_GT4:
	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1

	FLASH_READ_RAM ISP_ADDR_RAM,ISP_LEN,TX_DATA
	CLC
	LDA <ISP_ADDR_RAM
	ADC <ISP_LEN
	STA <ISP_ADDR_RAM
	LDA <ISP_ADDR_RAM+1
	ADC #00H
	STA <ISP_ADDR_RAM+1
	LDA <ISP_ADDR_RAM+2
	ADC #00H
	STA <ISP_ADDR_RAM+2

	LDX <ISP_LEN
	DEX
SEND_TX_NEXT_BYTE_ISPR_GT4_LOOP:
	CLC
	LDA <TX_DATA+4
	ADC <TX_DATA,X
	STA <TX_DATA+4

	CPX #00H
	BEQ SEND_TX_NEXT_BYTE_ISPR_END
	DEX 
	BRA SEND_TX_NEXT_BYTE_ISPR_GT4_LOOP
SEND_TX_NEXT_BYTE_ISPR_END:
	STZ <TX_BYTE_INDEX
	LDY #08H
	JMP MAIN_LOOP

SEND_TO_SDA_PIN_FINISH:
;SDA:output->input	
	LDA #SDA_PORT_D_BIT
	TSB !SDA_PORT_D	
;REFRESH_SCLK_SDA	

;loop SCL1
	LDA <RX_DATA
	CMP #CMD_PWR_DOWN
	BNE POLLING_TX_STOP_NEXT

SEND_TO_SDA_PIN_FINISH_NEXT:
	LDA #WDTC_CLR
	STA !WDTC	
	LDA !SCLK_PORT
	AND #SCLK_PORT_BIT
	BEQ SEND_TO_SDA_PIN_FINISH_NEXT
	STA <SCLK_PREV
;-----------------------------------------
POLLING_TX_STOP:
	LDA #TX_DOING
	BIT <NUSP_FLAG
	BNE 3
	JMP MAIN_LOOP

;SDA:output->input	
	LDA #SDA_PORT_D_BIT
	TSB !SDA_PORT_D	

POLLING_TX_STOP_NEXT:
	LDA #(TX_DOING+RX_DOING)
	TRB <NUSP_FLAG
	CLEAR_TX_RAM

	REFRESH_SCLK_SDA

	LDA #CMD_UNDO
	BIT <NUSP_FLAG1
	BEQ 3 
	JMP CMD_PROCESS

CMD_FINISH:
	CLEAR_RX_RAM
	LDA #WDTC_CLR
	STA !WDTC
	JMP MAIN_LOOP

CMD_PROCESS:
	LDA #SDA_OUT0
	BIT <NUSP_FLAG1
	BNE 3 
	JMP WAIT_AND_SET_SDA_OUT0_QUIT

WAIT_STOP_SCL1:
	LDA #WDTC_CLR
	STA !WDTC	
	LDA !SCLK_PORT
	AND #SCLK_PORT_BIT
	BEQ WAIT_STOP_SCL1
	STA <SCLK_PREV

WAIT_STOP_SDA1:
	LDA #WDTC_CLR
	STA !WDTC	
	LDA !SDA_PORT
	AND #SDA_PORT_BIT
	BEQ WAIT_STOP_SDA1

SET_SDA_OUT0:
	LDA #SDA_PORT_D_BIT
	TRB !SDA_PORT_D	
	LDA #SDA_PORT_BIT
	TRB !SDA_PORT
	STZ <SDA_PREV

WAIT_AND_SET_SDA_OUT0_QUIT:
	JMP (CMD_JUMP)

CMD_PROCESS_DONE:
	LDA #SDA_OUT0
	BIT <NUSP_FLAG1
	BNE 3 
	JMP NOT_RELOAD_SDA_INPUT
	LDA #SDA_PORT_D_BIT
	TSB !SDA_PORT_D	

NOT_RELOAD_SDA_INPUT:
	REFRESH_SCLK_SDA	
	LDA #(CMD_UNDO+SDA_OUT0)
	TRB <NUSP_FLAG1	
	JMP CMD_FINISH
;==========================================
READ_SDA_SET_VOL:
	LDA <RX_DATA+1
	STA <SP_VOLUME
	SET_SP_VOLUME_RT_RAM_NST SP_VOLUME,00
	JMP CMD_PROCESS_DONE
;-----------------------------------------	
;-----------------------------------------
READ_SDA_PAUSE:
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	LDA #PLAY_PAUSE
	BIT <NUSP_FLAG
	BNE 2
	TSB <NUSP_FLAG

	LDA PLAY_LAYER_INDEX
	CMP #CONTINUE_PLAY_LAYER
	BCC READ_SDA_PAUSE_NEXT
	DEC PLAY_LAYER_INDEX
	HW_CMD_DEL_PUSH_LAYER 1

.IF (CONTINUE_PLAY_LAYER .GT. 1)	
	LDA PLAY_FLAG_RAM+1
	STA PLAY_FLAG_RAM

	LDX #00H
READ_SDA_PAUSE_DEL_RAM_LOOP:
	LDA CONTINUE_PLAY_RAM+CONTINUE_PLAY_LAYER_RAM,X
	STA CONTINUE_PLAY_RAM,X
	INX
	CPX #CONTINUE_PLAY_LAYER_RAM
	BNE READ_SDA_PAUSE_DEL_RAM_LOOP
.ENDIF

READ_SDA_PAUSE_NEXT:
	HW_CMD_PUSH_PLAY 00

	LDX PLAY_LAYER_INDEX
	LDA <NUSP_FLAG
	AND #(SP_DOING+SIL_DOING+PLAY_REPEAT+MULTI_PLAY+SLEEP_AFTER+PLAY_PAUSE)
	STA PLAY_FLAG_RAM,X	

.IF (CONTINUE_PLAY_LAYER .GT. 1)	
	CPX #00H
	BEQ READ_SDA_PAUSE_NEXT_LAYER0
READ_SDA_PAUSE_NEXT_LAYER1:
	LDX #00H
READ_SDA_PAUSE_LOOP1:
	LDA <EQU_COUNTER,X
	STA CONTINUE_PLAY_RAM+CONTINUE_PLAY_LAYER_RAM,X
	INX
	CPX #CONTINUE_RAM_PLAY
	BNE READ_SDA_PAUSE_LOOP1

	LDX #00H
READ_SDA_PAUSE_LOOP1_1:
	LDA <MULTI_PLAY_INDEX,X
	STA CONTINUE_PLAY_RAM+CONTINUE_PLAY_LAYER_RAM+CONTINUE_RAM_PLAY,X
	INX
	CPX #CONTINUE_RAM_PLAY_MULTI
	BNE READ_SDA_PAUSE_LOOP1_1
	BRA READ_SDA_PAUSE_RAM_NEXT
.ENDIF

READ_SDA_PAUSE_NEXT_LAYER0:
	LDX #00H
READ_SDA_PAUSE_LOOP0:
	LDA <EQU_COUNTER,X
	STA CONTINUE_PLAY_RAM,X
	INX
	CPX #CONTINUE_RAM_PLAY
	BNE READ_SDA_PAUSE_LOOP0

	LDX #00H
READ_SDA_PAUSE_LOOP0_1:
	LDA <MULTI_PLAY_INDEX,X
	STA CONTINUE_PLAY_RAM+CONTINUE_RAM_PLAY,X
	INX
	CPX #CONTINUE_RAM_PLAY_MULTI
	BNE READ_SDA_PAUSE_LOOP0_1

READ_SDA_PAUSE_RAM_NEXT:
	LDA #(SP_DOING+SIL_DOING+MULTI_PLAY+PLAY_REPEAT+SLEEP_AFTER)
	TRB <NUSP_FLAG
	SP_FREE_WITHOUT_PA

	INC PLAY_LAYER_INDEX
	JMP CMD_PROCESS_DONE
.ENDIF
;-----------------------------------------
READ_SDA_RESUME:
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	CHK_BUSY_SENTENCE
	BEQ READ_SDA_RESUME_NOT_PLAYING
	STOP_FOR_NST 00

READ_SDA_RESUME_NOT_PLAYING:
	DEC PLAY_LAYER_INDEX
	.IF (CONTINUE_PLAY_LAYER .GT. 1)
	LDX PLAY_LAYER_INDEX	
	CPX #00H
	BEQ READ_SDA_RESUME_LAYER0
READ_SDA_RESUME_LAYER1:
	LDX #00H
READ_SDA_RESUME_LOOP1:
	LDA CONTINUE_PLAY_RAM+CONTINUE_PLAY_LAYER_RAM,X 
	STA <EQU_COUNTER,X
	INX
	CPX #CONTINUE_RAM_PLAY
	BNE READ_SDA_RESUME_LOOP1

	LDX #00H
READ_SDA_RESUME_LOOP1_1:
	LDA CONTINUE_PLAY_RAM+CONTINUE_PLAY_LAYER_RAM+CONTINUE_RAM_PLAY,X 
	STA <MULTI_PLAY_INDEX,X
	INX
	CPX #CONTINUE_RAM_PLAY_MULTI
	BNE READ_SDA_RESUME_LOOP1_1
	BRA READ_SDA_RESUME_RAM_NEXT
	.ENDIF

READ_SDA_RESUME_LAYER0:
	LDX #00H
READ_SDA_RESUME_LOOP0:
	LDA CONTINUE_PLAY_RAM,X 
	STA <EQU_COUNTER,X
	INX
	CPX #CONTINUE_RAM_PLAY
	BNE READ_SDA_RESUME_LOOP0

	LDX #00H
READ_SDA_RESUME_LOOP0_1:
	LDA CONTINUE_PLAY_RAM+CONTINUE_RAM_PLAY,X 
	STA <MULTI_PLAY_INDEX,X
	INX
	CPX #CONTINUE_RAM_PLAY_MULTI
	BNE READ_SDA_RESUME_LOOP0_1

READ_SDA_RESUME_RAM_NEXT:
	LDX PLAY_LAYER_INDEX
	LDA <NUSP_FLAG
	AND #(RX_DOING+TX_DOING)
	ORA PLAY_FLAG_RAM,X
	STA <NUSP_FLAG
	STZ PLAY_FLAG_RAM,X
	CPX #00H
	BNE READ_SDA_RESUME_RAM_NEXT1
	LDA <NUSP_FLAG
	AND #(FFH^PLAY_PAUSE)
	STA <NUSP_FLAG

READ_SDA_RESUME_RAM_NEXT1:
	HW_CMD_POP_PLAY 0,0
	LDA #SP_BUSY
	TSB <STATUS_FLAG
	SP_BUSY_SPBUSY_OUT

	JMP CMD_PROCESS_DONE
.ENDIF
;-----------------------------------------	
READ_SDA_STOP_EQU:
	STOP_FOR_NST 00
	LDA #(SP_DOING+SIL_DOING+MULTI_PLAY+PLAY_REPEAT+SLEEP_AFTER)
	TRB <NUSP_FLAG
	SP_FREE_PROC
	JMP CMD_PROCESS_DONE
;-----------------------------------------	
READ_SDA_PWR_DOWN:
	LDA #01H
READ_SDA_PWR_DOWN_NEXT:
	STA <TEMP_USED
	JSR STOP_PLAYING_PROC		
	JSR RESET_SLEEP_PROC
	STZ <NUSP_FLAG
	LDA <NUSP_FLAG1
	AND #(EN_STANDBY+SPBZOUT_EN)
	STA <NUSP_FLAG1

	RESET_SCLK_SDA

GOTO_ENTER_SLEEP:
	LDA #SCLK_PORT_BIT
	TSB !SCLK_PORT_EN
	LDA #INT0_PORT
	STA !IEF0

	LDA #WDTC_CLR
	STA !WDTC
	JSR SAVE_LIB_DPD_RAM

.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
	LDA #C7H
	TSB !BP0M
	LDA #08H
	TSB !BP1M
.ENDIF
.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
	LDA #07H
	TSB !BP0M
	LDA #E0H
	TSB !BP1M
.ENDIF	
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	LDA #03H
	TSB !BP0M
	LDA #8CH
	TSB !BP1M
	LDA #01H
	TSB !BP2M
.ENDIF
	STZ !WAKEF
	CLI
	STOP

	NOP	
;-----------------------------------------
READ_SDA_PWR_RESET:
	STZ <TEMP_USED
	JSR STOP_PLAYING_PROC
	JSR RESET_SLEEP_PROC
	STZ <NUSP_FLAG1
	STZ <NUSP_FLAG

GOTO_ENTER_RESET:
	LDA #WDTC_CLR
	STA !WDTC

	STZ !WAKEF
	CLI
	JMP MAIN_START
;-----------------------------------------
READ_SDA_DO_LVD:
	LDA #LVD_DOING 
	TSB <NUSP_FLAG1
.IFDEF STANDBY_TIME
	LDA #EN_STANDBY
	BIT <NUSP_FLAG1
	BEQ READ_SDA_DO_LVD_NEXT

	LDA #ENTER_STANDBY
	TRB <NUSP_FLAG1
	CLEAR_STANDBY_RAM
READ_SDA_DO_LVD_NEXT:
.ENDIF

	LDA #03H
	STA <LVD_COUNT
	LDA #01H
	STA <LVD_INDEX
	TAX	
	LDA !LVDC_SETTNG_TABLE,X
	STA !LVDC
	SEI
	LDA #INT0_FXF10
	STA !EVF0
	TSB !IEF0
	CLI
	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_DO_CHECKSUM:
	JSR STOP_PLAY_CLEAR_RAM_PROC
	JSR DO_CHECKSUM_PROCESS

	NSP_RESET_HWE_SETTING

.IFDEF STANDBY_TIME
	CLEAR_STANDBY_RAM
.ENDIF
	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_SPBZOUT_EN:
.IFDEF SPBUSY_OUT_PIN	
	LDA #SPBZOUT_EN 
	TSB <NUSP_FLAG1

	LDA <NUSP_FLAG
	BIT #SP_DOING
	BNE READ_SDA_SPBZOUT_EN_DOING	
	LDA #SPBUSY_OUT_PORT_BIT
	TSB !SPBUSY_OUT_PORT	
	BRA READ_SDA_SPBZOUT_EN_NEXT
READ_SDA_SPBZOUT_EN_DOING:
	LDA #SPBUSY_OUT_PORT_BIT
	TRB !SPBUSY_OUT_PORT
READ_SDA_SPBZOUT_EN_NEXT:
	LDA #SPBUSY_OUT_PORT_D_BIT
	TRB !SPBUSY_OUT_PORT_D
	LDA #SPBUSY_OUT_IOFLAG
	TRB <IO_FLAG 
.ENDIF
	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_SPBZOUT_DIS:
.IFDEF SPBUSY_OUT_PIN
	LDA #SPBZOUT_EN 
	TRB <NUSP_FLAG1
	LDA #SPBUSY_OUT_PORT_D_BIT
	TSB !SPBUSY_OUT_PORT_D
	LDA #SPBUSY_OUT_IOFLAG
	TSB <IO_FLAG
.ENDIF
	JMP CMD_PROCESS_DONE
;-----------------------------------------
;-----------------------------------------
READ_SDA_SET_IO_CONFIG:
	LDA <RX_DATA+1
	STA <IO_FLAG

.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')	
	DO_PIN_CONFIG  BP13_TYPE,BP13_PORT_D_BIT,BP13_PORT_D
	DO_PIN_CONFIG  BP07_TYPE,BP07_PORT_D_BIT,BP07_PORT_D	
.IFNDEF EXT_PA	
	DO_PIN_CONFIG  BP06_TYPE,BP06_PORT_D_BIT,BP06_PORT_D
.ENDIF
	DO_PIN_CONFIG  BP02_TYPE,BP02_PORT_D_BIT,BP02_PORT_D
.ENDIF

.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')	
	DO_PIN_CONFIG  BP17_TYPE,BP17_PORT_D_BIT,BP17_PORT_D	
.IFNDEF EXT_PA	
	DO_PIN_CONFIG  BP16_TYPE,BP16_PORT_D_BIT,BP16_PORT_D
.ENDIF
	DO_PIN_CONFIG  BP15_TYPE,BP15_PORT_D_BIT,BP15_PORT_D
	DO_PIN_CONFIG  BP02_TYPE,BP02_PORT_D_BIT,BP02_PORT_D
.ENDIF

.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')	
	DO_PIN_CONFIG  BP20_TYPE,BP20_PORT_D_BIT,BP20_PORT_D	
.IFNDEF EXT_PA
	DO_PIN_CONFIG  BP17_TYPE,BP17_PORT_D_BIT,BP17_PORT_D
.ENDIF
	DO_PIN_CONFIG  BP13_TYPE,BP13_PORT_D_BIT,BP13_PORT_D
	DO_PIN_CONFIG  BP12_TYPE,BP12_PORT_D_BIT,BP12_PORT_D
.ENDIF

READ_SDA_SET_IO_CONFIG_END:
	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_SET_OUT:
.IF (PARTNO='N589D080').OR.(PARTNO='N589D170').OR.(PARTNO='N589D340')
	SET_OUT_VALUE BP13_LOC,BP13_PORT_D_BIT,BP13_PORT_D,BP13_PORT_BIT,BP13_PORT
	SET_OUT_VALUE BP07_LOC,BP07_PORT_D_BIT,BP07_PORT_D,BP07_PORT_BIT,BP07_PORT
.IFNDEF EXT_PA
	SET_OUT_VALUE BP06_LOC,BP06_PORT_D_BIT,BP06_PORT_D,BP06_PORT_BIT,BP06_PORT
.ENDIF
	SET_OUT_VALUE BP02_LOC,BP02_PORT_D_BIT,BP02_PORT_D,BP02_PORT_BIT,BP02_PORT
.ENDIF
.IF (PARTNO='N589D081').OR.(PARTNO='N589D171').OR.(PARTNO='N589D341').OR.(PARTNO='N589D481')
	SET_OUT_VALUE BP17_LOC,BP17_PORT_D_BIT,BP17_PORT_D,BP17_PORT_BIT,BP17_PORT
.IFNDEF EXT_PA
	SET_OUT_VALUE BP16_LOC,BP16_PORT_D_BIT,BP16_PORT_D,BP16_PORT_BIT,BP16_PORT
.ENDIF
	SET_OUT_VALUE BP15_LOC,BP15_PORT_D_BIT,BP15_PORT_D,BP15_PORT_BIT,BP15_PORT
	SET_OUT_VALUE BP02_LOC,BP02_PORT_D_BIT,BP02_PORT_D,BP02_PORT_BIT,BP02_PORT
.ENDIF
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	SET_OUT_VALUE BP20_LOC,BP20_PORT_D_BIT,BP20_PORT_D,BP20_PORT_BIT,BP20_PORT
.IFNDEF EXT_PA
	SET_OUT_VALUE BP17_LOC,BP17_PORT_D_BIT,BP17_PORT_D,BP17_PORT_BIT,BP17_PORT
.ENDIF
	SET_OUT_VALUE BP13_LOC,BP13_PORT_D_BIT,BP13_PORT_D,BP13_PORT_BIT,BP13_PORT
	SET_OUT_VALUE BP12_LOC,BP12_PORT_D_BIT,BP12_PORT_D,BP12_PORT_BIT,BP12_PORT
.ENDIF

READ_SDA_SET_OUT_END:
	JMP CMD_PROCESS_DONE	
;-----------------------------------------
;-----------------------------------------
READ_SDA_PLAY:
	STZ <RAM_BUFFER+2
	LDA <RX_DATA+1			;H
	STA <RAM_BUFFER+1	;H
	LDA <RX_DATA+2
	STA <RAM_BUFFER	;L

READ_SDA_PLAY_NEXT:
	JSR PLAY_CMD_PROCESS
	BNE 3
	JMP CMD_PROCESS_DONE

	LDA <RX_DATA+1			;H
	STA <PLAY_LIST_INDEX+1	;H
	LDA <RX_DATA+2
	STA <PLAY_LIST_INDEX	;L
	LDA #(PLAY_REPEAT+MULTI_PLAY)
	TRB <NUSP_FLAG

	LDA <PLAY_TYPE
	BEQ READ_SDA_PLAY_NOT_SLEEP1	
READ_SDA_SLEEP_AFTER_PLAY1:
	LDA #SLEEP_AFTER
	TSB <NUSP_FLAG
	JMP CMD_PROCESS_DONE
READ_SDA_PLAY_NOT_SLEEP1:
	LDA #SLEEP_AFTER
	TRB <NUSP_FLAG
	JMP CMD_PROCESS_DONE
;-----------------------------------------	
READ_SDA_MULTI_PLAY:
	LDA MULTI_PLAY_NUMBER_RX
	STA <MULTI_PLAY_NUMBER
	ASL A
	STA MULTI_PLAY_NUMBER_RX
	STZ <MULTI_PLAY_INDEX

	LDX #00H
READ_SDA_MULTI_PLAY_LOAD:
	LDA MULTI_PLAY_BUFFER_RX,X	
	STA MULTI_PLAY_BUFFER,X
	INX
	LDA MULTI_PLAY_BUFFER_RX,X	
	STA MULTI_PLAY_BUFFER,X
	INX
	CPX MULTI_PLAY_NUMBER_RX
	BCC READ_SDA_MULTI_PLAY_LOAD

READ_SDA_MULTI_PLAY_TODO:
	STZ <RAM_BUFFER+2	
	LDA <MULTI_PLAY_INDEX	
	ASL A
	TAX	
	LDA MULTI_PLAY_BUFFER,X
	STA <RAM_BUFFER+1	;H
	LDA MULTI_PLAY_BUFFER+1,X
	STA <RAM_BUFFER	;L

	MULTI_PLAY_CHK_INDEX   READ_SDA_MULTI_PLAY_TODO1,READ_SDA_MULTI_PLAY_TODO,CMD_PROCESS_DONE		
READ_SDA_MULTI_PLAY_TODO1:
	LDA #02H
	STA <PLAY_TYPE
	JSR PLAY_CMD_PROCESS
	BNE 3
	JMP CMD_PROCESS_DONE

	LDA #MULTI_PLAY
	TSB <NUSP_FLAG
	LDA #(PLAY_REPEAT+SLEEP_AFTER)
	TRB <NUSP_FLAG
	JMP CMD_PROCESS_DONE	
;-----------------------------------------
;-----------------------------------------
.IF (WITH_ISP .EQ. 1)
READ_SDA_ISP_WRITE_START:
	JSR STOP_PLAY_CLEAR_RAM_PROC		
	JSR NSP_EXPAN_RAM

	STZ <ISP_START_ADDR_RAM
	STZ <ISP_START_ADDR_RAM+1
	STZ <ISP_START_ADDR_RAM+2
	STZ <ISP_END_ADDR_RAM
	STZ <ISP_END_ADDR_RAM+1
	STZ <ISP_END_ADDR_RAM+2
	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_ISP_WRITE_END:
	JSR NSP_RELOAD_RAM

UPDATE_STARTADDR_AFTER_ISP_WRITE:
	FLASH_READ READ_ISP_ADDR,6,RAM_BUFFER
	LDA <RAM_BUFFER+2
	STA <STARTADDR_PLAYLIST

	LDA <RAM_BUFFER+3
	STA <STARTADDR_PLAYLIST+1
	LDA <RAM_BUFFER+4
	STA <STARTADDR_PLAYLIST+2

;init ID_RAM(4B)+CHIP_PDID(4B)+PLAY_LIST_COUNT(2B)	
	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM STARTADDR_PLAYLIST,ISP_LEN,ID_RAM
	ADC_ADDR_DP	STARTADDR_PLAYLIST,8,PLAY_LIST_ADDR	
	LDA #02H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM PLAY_LIST_ADDR,ISP_LEN,PLAY_LIST_COUNT

UPDATE_CHECKSUM_AFTER_ISP_WRITE:
	JSR ISP_CHECKSUM_LIB

	NSP_RESET_HWE
	NSP_RESET_HWE_SETTING
	JMP CMD_PROCESS_DONE
;-----------------------------------------	
READ_SDA_ISP_WRITE_PAGE:
	LDA <RX_DATA+1
	STA <ISP_ADDR_RAM+2
	LDA <RX_DATA+2
	STA <ISP_ADDR_RAM+1
	LDA <RX_DATA+3
	STA <ISP_ADDR_RAM

	JSR GET_ISP_START_END_ADDR

READ_SDA_ISP_WRITE_PAGE_NEXT:
	FLASH_ERASE_PAGE_RAM ISP_ADDR_RAM
	FLASH_WRITE_RAM ISP_ADDR_RAM, ISP_LEN, ISP_WRITE_PAGE_BUFFER

	STZ <ISP_LEN
	STZ <ISP_LEN+1
	JMP CMD_PROCESS_DONE
;-----------------------------------------
;-----------------------------------------
READ_SDA_ISP_WRITE_PARTIAL_START:
	JMP READ_SDA_ISP_WRITE_START
;-----------------------------------------		
READ_SDA_ISP_WRITE_PARTIAL_BAK:
	LDA <RX_DATA+1
	STA <ISP_ADDR_RAM+2
	LDA <RX_DATA+2
	AND #FEH
	STA <ISP_ADDR_RAM+1
	STZ <ISP_ADDR_RAM

	LDA #.LOW.ISP_WRITE_PAGE_SIZE
	STA <ISP_LEN
	LDA #.HIGH.ISP_WRITE_PAGE_SIZE
	STA <ISP_LEN+1

	FLASH_ERASE_PAGE_RAM ISP_SWAP_RAM
	FLASH_READ_RAM ISP_ADDR_RAM,ISP_LEN,ISP_WRITE_PAGE_BUFFER
	FLASH_WRITE_RAM ISP_SWAP_RAM,ISP_LEN,ISP_WRITE_PAGE_BUFFER

	STZ <RAM_BUFFER
	CLC
	LDA <ISP_SWAP_RAM+1
	ADC #02H
	STA <RAM_BUFFER+1
	LDA <ISP_SWAP_RAM+2
	ADC #00H
	STA <RAM_BUFFER+2	
	LDA #03H
	STA <ISP_LEN
	STZ <ISP_LEN+1

	FLASH_ERASE_PAGE_RAM RAM_BUFFER
	FLASH_WRITE_RAM RAM_BUFFER,ISP_LEN,ISP_ADDR_RAM
	LDA #04H
	STA <RAM_BUFFER
	FLASH_WRITE_RAM RAM_BUFFER,ISP_LEN,ISP_ADDR_RAM

	STZ <ISP_LEN
	LDA #WDTC_CLR
	STA !WDTC
	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_ISP_WRITE_PARTIAL:
	LDA <RX_DATA+1
	STA <ISP_ADDR_RAM+2
	LDA <RX_DATA+2
	AND #FEH
	STA <ISP_ADDR_RAM+1
	STZ <ISP_ADDR_RAM

	LDA #.LOW.ISP_WRITE_PAGE_SIZE
	STA ISP_LEN
	LDA #.HIGH.ISP_WRITE_PAGE_SIZE
	STA ISP_LEN+1

	JSR GET_ISP_START_END_ADDR

READ_SDA_ISP_WRITE_PARTIAL_NEXT:
	FLASH_ERASE_PAGE_RAM ISP_ADDR_RAM
	FLASH_WRITE_RAM ISP_ADDR_RAM, ISP_LEN, ISP_WRITE_PAGE_BUFFER

	STZ <RAM_BUFFER
	CLC
	LDA <ISP_SWAP_RAM+1
	ADC #02H
	STA <RAM_BUFFER+1
	LDA <ISP_SWAP_RAM+2
	ADC #00H
	STA <RAM_BUFFER+2	
	FLASH_ERASE_PAGE_RAM RAM_BUFFER
	FLASH_ERASE_PAGE_RAM ISP_SWAP_RAM	

	STZ <ISP_LEN
	STZ <ISP_LEN+1
	LDA #WDTC_CLR
	STA !WDTC

	JMP CMD_PROCESS_DONE
;-----------------------------------------
GET_ISP_START_END_ADDR:
	LDA <ISP_START_ADDR_RAM+2
	ORA <ISP_START_ADDR_RAM+1
	ORA <ISP_START_ADDR_RAM	
	BNE GET_ISP_ADDR_CMP

	LDA <RX_DATA+1
	STA <ISP_START_ADDR_RAM+2
	LDA <RX_DATA+2
	STA <ISP_START_ADDR_RAM+1
	LDA <RX_DATA+3
	STA <ISP_START_ADDR_RAM

	LDA <RAM_BUFFER
	STA <ISP_END_ADDR_RAM
	LDA <RAM_BUFFER+1
	STA <ISP_END_ADDR_RAM+1
	LDA <RAM_BUFFER+2
	STA <ISP_END_ADDR_RAM+2
	RTS

GET_ISP_ADDR_CMP:
	LDA <RX_DATA+1	
	CMP <ISP_START_ADDR_RAM+2
	BCC GET_ISP_STA_START_ADDR
	BEQ 2
	BRA GET_ISP_ADDR_CMP_END
	LDA <RX_DATA+2
	CMP <ISP_START_ADDR_RAM+1
	BCC GET_ISP_STA_START_ADDR
	BEQ 2
	BRA GET_ISP_ADDR_CMP_END
	LDA <RX_DATA+3
	CMP <ISP_START_ADDR_RAM
	BCC GET_ISP_STA_START_ADDR
	BCS GET_ISP_ADDR_CMP_END

GET_ISP_STA_START_ADDR:
	LDA <RX_DATA+1
	STA <ISP_START_ADDR_RAM+2
	LDA <RX_DATA+2
	STA <ISP_START_ADDR_RAM+1
	LDA <RX_DATA+3
	STA <ISP_START_ADDR_RAM	

GET_ISP_ADDR_CMP_END:
	LDA <ISP_END_ADDR_RAM+2
	CMP <RAM_BUFFER+2
	BCC GET_ISP_STA_END_ADDR
	BEQ 2
	BRA GET_ISP_START_END_ADDR_END
	LDA <ISP_END_ADDR_RAM+1
	CMP <RAM_BUFFER+1
	BCC GET_ISP_STA_END_ADDR
	BEQ 2
	BRA GET_ISP_START_END_ADDR_END
	LDA <ISP_END_ADDR_RAM
	CMP <RAM_BUFFER
	BCC GET_ISP_STA_END_ADDR
	BCS GET_ISP_START_END_ADDR_END

GET_ISP_STA_END_ADDR:
	LDA <RAM_BUFFER
	STA <ISP_END_ADDR_RAM
	LDA <RAM_BUFFER+1
	STA <ISP_END_ADDR_RAM+1
	LDA <RAM_BUFFER+2
	STA <ISP_END_ADDR_RAM+2
GET_ISP_START_END_ADDR_END:
	RTS
;======================================================		
ISP_CHECKSUM_LIB:
	STZ <ISP_CHECKSUM_BYTE
	STZ <ISP_CHECKSUM_BYTE+1

	LDA <ISP_START_ADDR_RAM
	AND #03H
	STA <TEMP_USED
	LDA <ISP_START_ADDR_RAM
	AND #FCH
	STA !ISPADR0
	LDA <ISP_START_ADDR_RAM+1
	STA !ISPADR1
	LDA <ISP_START_ADDR_RAM+2
	STA !ISPADR2

	LDA <ISP_END_ADDR_RAM
	AND #03H
	STA <TEMP_USED+1
	LDA <ISP_END_ADDR_RAM
	AND #FCH
	STA <ISP_END_ADDR_RAM

;
; process ROM_START - 60FFFH DATA
;
	LDA #A6H
	STA !ISPULK
	LDA #E9H
	STA !ISPULK
	LDA #77H
	STA !ISPULK	
	LDA #ISP_EN
	TSB !ISPCON
	LDA #ISP_CMD_READ
	STA !ISPCMD

CHECKSUM_LOOP_ISP_H:
	LDY #00H
	LDA <ISP_START_ADDR_RAM+2
	CMP <ISP_END_ADDR_RAM+2
	BNE ISP_CHECKSUM_LIB_NEXT
	LDA <ISP_START_ADDR_RAM+1
	CMP <ISP_END_ADDR_RAM+1
	BNE ISP_CHECKSUM_LIB_NEXT
	LDA <ISP_START_ADDR_RAM
	CMP <ISP_END_ADDR_RAM
	BCC ISP_CHECKSUM_LIB_NEXT
	LDY #04H
	BRA CHECKSUM_LOOP_ISP

ISP_CHECKSUM_LIB_NEXT:
	LDA <TEMP_USED
	BEQ CHECKSUM_LOOP_ISP
	LDY #01H

CHECKSUM_LOOP_ISP:
	LDA #WDTC_CLR
	STA !WDTC

	LDA #ISP_DONE
	TSB !ISPTRG
POLLING_ISP_TRG_ISP:
	LDA !ISPTRG
	AND #ISP_DONE
	BNE POLLING_ISP_TRG_ISP

	CPY #04H
	BNE POLLING_ISP_TRG_ISP_1
	LDX <TEMP_USED
	BRA CHECKSUM_ACC_ISP
POLLING_ISP_TRG_ISP_1:
	CPY #01H
	BNE SET_X_NOT_H
	LDY #02H
	LDX <TEMP_USED
	BRA CHECKSUM_ACC_ISP
SET_X_NOT_H:
	LDX #00H
CHECKSUM_ACC_ISP:
	CLC
	LDA !ISPDAT0, X
	ADC <ISP_CHECKSUM_BYTE
	STA <ISP_CHECKSUM_BYTE
	LDA <ISP_CHECKSUM_BYTE+1
	ADC #00H
	STA <ISP_CHECKSUM_BYTE+1

	INX
	CPY #03H
	BCC CMP_X_NOT_T
	CPX <TEMP_USED+1
	BNE CHECKSUM_ACC_ISP
	JMP END_CHECKSUM_ISP
CMP_X_NOT_T:
	CPX #4
	BNE CHECKSUM_ACC_ISP

ROM_ADDR_INC_ISP:
	CLC
	LDA !ISPADR0
	ADC #4
	STA !ISPADR0
	BNE ROM_ADDR_CHECK_ISP
	INC !ISPADR1
	BNE ROM_ADDR_CHECK_ISP
	INC !ISPADR2
	BRA ROM_ADDR_CHECK_ISP

ROM_ADDR_CHECK_ISP:
;
; check if it is the last address
;
	LDA !ISPADR2
	CMP <ISP_END_ADDR_RAM+2
	BNE CHECKSUM_LOOP_ISP
	LDA !ISPADR1
	CMP <ISP_END_ADDR_RAM+1
	BNE CHECKSUM_LOOP_ISP
	LDA !ISPADR0
	CMP <ISP_END_ADDR_RAM
	BEQ CHECKSUM_ISP_CHK_T	
	JMP CHECKSUM_LOOP_ISP

CHECKSUM_ISP_CHK_T:
	LDA <TEMP_USED+1
	BEQ END_CHECKSUM_ISP
	LDY #03H
	JMP CHECKSUM_LOOP_ISP

END_CHECKSUM_ISP:
	LDA #WDTC_CLR
	STA !WDTC

	LDA	#ISP_EN
	TRB !ISPCON
	STZ !ISPULK
	RTS	
;======================================================
GET_ISP_SWAPPING_RAM:
	LDA #.LOW._ISPSWAPPINGPAGE_
	STA ISP_SWAP_RAM
	CLC
	LDA #.HIGH8._ISPSWAPPINGPAGE_
	ROR A
	STA ISP_SWAP_RAM+2
	BCS GET_ISP_SWAPPING_RAM_NEXT
	SEC
	LDA #.HIGH._ISPSWAPPINGPAGE_
	SBC #80H
	BRA 2
GET_ISP_SWAPPING_RAM_NEXT:
	LDA #.HIGH._ISPSWAPPINGPAGE_
	STA ISP_SWAP_RAM+1
	RTS 
;-----------------------------------------
CHECK_ISP_PARTIAL_ERROR_DOUBLE:
	LDA ISP_SWAP_RAM
	ORA ISP_SWAP_RAM+1
	ORA ISP_SWAP_RAM+2
	BEQ 3
	JMP CHECK_ISP_PARTIAL_ERROR_END

CHECK_ISP_PARTIAL_ERROR:
	JSR GET_ISP_SWAPPING_RAM

	STZ <RAM_BUFFER
	CLC
	LDA <ISP_SWAP_RAM+1
	ADC #02H
	STA <RAM_BUFFER+1
	LDA <ISP_SWAP_RAM+2
	ADC #00H
	STA <RAM_BUFFER+2	
	LDA #08H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM RAM_BUFFER,ISP_LEN,RAM_BUFFER+3

	LDA <RAM_BUFFER+3
	CMP <RAM_BUFFER+7
	BNE ISP_SWAP_ADDR_ERROR_GOTO
	LDA <RAM_BUFFER+4
	CMP <RAM_BUFFER+8
	BNE ISP_SWAP_ADDR_ERROR_GOTO
	LDA <RAM_BUFFER+5
	CMP <RAM_BUFFER+9
	BNE ISP_SWAP_ADDR_ERROR_GOTO

	LDA <RAM_BUFFER+3
	CMP #FFH
	BNE ISP_PARTIAL_ERROR_RELOAD
	LDA <RAM_BUFFER+4
	CMP #FFH
	BNE ISP_PARTIAL_ERROR_RELOAD
	LDA <RAM_BUFFER+5
	CMP #FFH
	BNE ISP_PARTIAL_ERROR_RELOAD
ISP_SWAP_ADDR_ERROR_GOTO:
	JMP ISP_SWAP_ADDR_ERROR

ISP_PARTIAL_ERROR_RELOAD:
	JSR NSP_EXPAN_RAM

	LDA #.LOW.ISP_WRITE_PAGE_SIZE
	STA <ISP_LEN
	LDA #.HIGH.ISP_WRITE_PAGE_SIZE
	STA <ISP_LEN+1

	FLASH_READ_RAM ISP_SWAP_RAM, ISP_LEN, ISP_WRITE_PAGE_BUFFER 
	FLASH_ERASE_PAGE_RAM RAM_BUFFER+3
	FLASH_WRITE_RAM RAM_BUFFER+3, ISP_LEN, ISP_WRITE_PAGE_BUFFER

	FLASH_ERASE_PAGE_RAM RAM_BUFFER
	FLASH_ERASE_PAGE_RAM ISP_SWAP_RAM
	LDA #WDTC_CLR
	STA !WDTC
	STZ <ISP_LEN
	STZ <ISP_LEN+1

	JSR NSP_RELOAD_RAM
	NSP_RESET_HWE

ISP_SWAP_ADDR_ERROR:
	STZ <RAM_BUFFER+3
	STZ <RAM_BUFFER+4
	STZ <RAM_BUFFER+5
	STZ <RAM_BUFFER+6
	STZ <RAM_BUFFER+7
	STZ <RAM_BUFFER+8
	STZ <RAM_BUFFER+9
	STZ <RAM_BUFFER+10

CHECK_ISP_PARTIAL_ERROR_END:
	LDA #WDTC_CLR
	STA !WDTC	
	RTS
.ENDIF
;-----------------------------------------
;-----------------------------------------
NSP_CHK_SYS_HANDSHAKE_PROC:
	LDA #WDTC_CLR
	STA !WDTC
	LDA HWE_CMD_BA+CMD_IDX
	BEQ 3							;WAIT TO HANDSHAKE
	JMP NSP_CHK_SYS_HANDSHAKE_PROC
	RTS
;-----------------------------------------
CHK_HWENGINE_POWERDOWN:
	LDA #WDTC_CLR
	STA !WDTC
	LDA !HWENG
	BNE CHK_HWENGINE_POWERDOWN
	LDA #00H
	STA HWE_STATUS_BA
	RTS	
;-----------------------------------------		
READ_SDA_ISP_READ_RES_INDEX:
	JSR STOP_PLAY_CLEAR_RAM_PROC		;HWENG=0
	JSR CHK_HWENGINE_POWERDOWN

	FLASH_READ 200000H, 4, RAM_BUFFER	;get USRCFG2	

;JSR ISP_HWE_READY_PROC	
	JSR NSP_CHK_SYS_HANDSHAKE_PROC
	STZ HWE_CMD_BA+CMD_PARAMETER+3		;CODE OPTIMIZATION
; Disable HWE idle notifications
	PHP
	SEI
	LDA #02H		;standby flag
	TRB HWE_CTRL_BA	
	LDA #10H		;ISP  flag
	TSB HWE_CTRL_BA
	PLP
	LDA #01H
	TSB !HWENG	
CHK_HWE_STATUS:
	LDA HWE_STATUS_BA
	CMP #FFH
	BNE CHK_HWE_STATUS

;JSR NSP_HWE_TABLE_BA_PROC
	PHP
	SEI
	LDA	#.LOW._TABLE.BIN
	STA HWE_CMD_BA+CMD_PARAMETER
	LDA	#.HIGH._TABLE.BIN
	STA HWE_CMD_BA+CMD_PARAMETER+1
	LDA	#.HIGH8._TABLE.BIN
	STA HWE_CMD_BA+CMD_PARAMETER+2
	LDA	#.SEGHIGH._TABLE.BIN
	STA HWE_CMD_BA+CMD_PARAMETER+3

	LDA #CMD_LOGIC_BA			;A9H
	STA HWE_CMD_BA+CMD_IDX
	LDA #02H
	TSB !INTRF
	PLP
	JSR NSP_CHK_SYS_HANDSHAKE_PROC

	PHP
	SEI
	LDA <RX_DATA+2			;Resource index low
	STA HWE_CMD_BA+CMD_PARAMETER
	LDA <RX_DATA+1			;Resource index high
	STA HWE_CMD_BA+CMD_PARAMETER+1
	LDA #.LOW.MAX_RESOURCE_NUM      ;Max Resource index low
	STA HWE_CMD_BA+CMD_PARAMETER+2
	LDA #.HIGH.MAX_RESOURCE_NUM     ;Max Resource index hogh
	STZ HWE_CMD_BA+CMD_PARAMETER+3
	LDA <RAM_BUFFER+2		;USRCFG2

	LDA #60H
	STA HWE_CMD_BA+CMD_IDX
	LDA <RAM_BUFFER+2		;USRCFG2
	.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	.ELSE
	AND #7FH		;USRCFG2[6:4]:m;USRCFG2[3:0]:n
	.ENDIF
	STA HWE_CMD_BA+CMD_CH_IDX
	LDA #02H
	TSB !INTRF
	PLP
	JSR NSP_CHK_SYS_HANDSHAKE_PROC

	LDX #FFH
READ_SDA_ISP_READ_RES_INDEX_LOOP:
	INX
	LDA !(HWE_STATUS_BA-FH),X
	STA ISP_PARTIAL_HEAD_PAGE_RAM,X
	CPX #0EH
	BCC READ_SDA_ISP_READ_RES_INDEX_LOOP

	NSP_RESET_HWE_AFTER_ISP_PARTIAL
	NSP_RESET_HWE_SETTING

	STZ ISP_PARTIAL_REAL_SIZE_RAM
	LDA ISP_PARTIAL_PAGE_COUNT_RAM
	STA ISP_PARTIAL_REAL_SIZE_RAM+1
	LDA ISP_PARTIAL_PAGE_COUNT_RAM+1
	STA ISP_PARTIAL_REAL_SIZE_RAM+2	
	CLC
	ROL ISP_PARTIAL_REAL_SIZE_RAM+1
	ROL ISP_PARTIAL_REAL_SIZE_RAM+2
	CLC
	LDA ISP_PARTIAL_REAL_SIZE_RAM
	ADC ISP_PARTIAL_HEAD_BYTE_RAM
	STA ISP_PARTIAL_REAL_SIZE_RAM
	LDA ISP_PARTIAL_REAL_SIZE_RAM+1
	ADC ISP_PARTIAL_HEAD_BYTE_RAM+1
	STA ISP_PARTIAL_REAL_SIZE_RAM+1
	LDA ISP_PARTIAL_REAL_SIZE_RAM+2
	ADC #00H
	STA ISP_PARTIAL_REAL_SIZE_RAM+2
	CLC
	LDA ISP_PARTIAL_REAL_SIZE_RAM
	ADC ISP_PARTIAL_TAIL_BYTE_RAM
	STA ISP_PARTIAL_REAL_SIZE_RAM
	LDA ISP_PARTIAL_REAL_SIZE_RAM+1
	ADC ISP_PARTIAL_TAIL_BYTE_RAM+1
	STA ISP_PARTIAL_REAL_SIZE_RAM+1
	LDA ISP_PARTIAL_REAL_SIZE_RAM+2
	ADC #00H
	STA ISP_PARTIAL_REAL_SIZE_RAM+2

	JMP CMD_PROCESS_DONE
;-----------------------------------------
READ_SDA_ISP_GET_RES_INFO:
	CMD_CHK_CHECKSUM
	LDA ISP_PARTIAL_REAL_SIZE_RAM+2
	STA <TX_DATA
	LDA ISP_PARTIAL_REAL_SIZE_RAM+1
	STA <TX_DATA+1
	LDA ISP_PARTIAL_REAL_SIZE_RAM
	STA <TX_DATA+2

	LDA ISP_PARTIAL_START_ADDR_RAM+2
	STA <TX_DATA+3
	LDA ISP_PARTIAL_START_ADDR_RAM+1
	STA <TX_DATA+4
	LDA ISP_PARTIAL_START_ADDR_RAM
	STA <TX_DATA+5

	LDA ISP_PARTIAL_HEAD_BYTE_RAM+1
	STA <TX_DATA+6
	LDA ISP_PARTIAL_HEAD_BYTE_RAM
	STA <TX_DATA+7

	LDA ISP_PARTIAL_PAGE_COUNT_RAM+1
	STA <TX_DATA+8
	LDA ISP_PARTIAL_PAGE_COUNT_RAM
	STA <TX_DATA+9

	LDA ISP_PARTIAL_TAIL_BYTE_RAM+1
	STA <TX_DATA+10
	LDA ISP_PARTIAL_TAIL_BYTE_RAM
	STA <TX_DATA+11

READ_SDA_ISP_GET_RES_INFO_NEXT:
	STZ <TX_DATA+12
	LDX #FFH
READ_SDA_ISP_GET_RES_INFO_LOOP:
	INX
	CLC
	LDA <TX_DATA,X
	ADC <TX_DATA+12
	STA <TX_DATA+12
	CPX #0BH
	BCC READ_SDA_ISP_GET_RES_INFO_LOOP
	LDA <TX_DATA+12
	EOR #FFH
	STA <TX_DATA+12

	LDA #CMD_VALID
	TSB <STATUS_FLAG
	LDA #0DH
	JMP CHANGE_TO_TX	
;-----------------------------------------
READ_SDA_ISP_GET_USER_SPACE_INFO:
	CMD_CHK_CHECKSUM
	FLASH_READ READ_USER_DATA_ADDR,6,RAM_BUFFER
	LDA <RAM_BUFFER+2
	STA <TX_DATA+5		;start address low
	LDA <RAM_BUFFER+3
	STA <TX_DATA+4		;start address high
	LDA <RAM_BUFFER+4
	STA <TX_DATA+3		;start address high8

	LDA #.LOW.USER_SPACE_SIZE
	STA <TX_DATA+2		;space size low
	LDA #.HIGH.USER_SPACE_SIZE
	STA <TX_DATA+1		;space size high
	LDA #.HIGH8.USER_SPACE_SIZE
	STA <TX_DATA		;space size high8

	LDA <TX_DATA+5		;start address low
	STA <RAM_BUFFER
	LDA <TX_DATA+4		;start address high
	AND #01H
	STA <RAM_BUFFER+1

	LDA <RAM_BUFFER
	ORA <RAM_BUFFER+1
	BNE READ_SDA_ISP_GET_USER_SPACE_INFO_1
	STZ <TX_DATA+7
	STZ <TX_DATA+6
	BRA READ_SDA_ISP_GET_USER_SPACE_INFO_NEXT
READ_SDA_ISP_GET_USER_SPACE_INFO_1:
	SEC
	LDA #00H
	SBC <RAM_BUFFER
	STA <TX_DATA+7		;1st low
	LDA #02H
	SBC <RAM_BUFFER+1
	STA <TX_DATA+6		;1st high

READ_SDA_ISP_GET_USER_SPACE_INFO_NEXT:
	SEC
	LDA <TX_DATA+2
	SBC <TX_DATA+7
	STA <TX_DATA+11		;last low
	LDA <TX_DATA+1
	SBC <TX_DATA+6
	STA <TX_DATA+9
	LDA <TX_DATA
	SBC #00H
	STA <TX_DATA+8

	LDA <TX_DATA+9
	AND #01H
	STA <TX_DATA+10		;last high

	LSR <TX_DATA+8		;/200H,page high
	ROR <TX_DATA+9		;page low
	JMP READ_SDA_ISP_GET_RES_INFO_NEXT
;======================================================	
GET_SPEECH_SENTENCE_PLAYLIST:
	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM EQU_ADDR,ISP_LEN,RAM_BUFFER

	LDA #WDTC_CLR
	STA !WDTC
	JSR HWE_READY_PROC
	JSR NSP_CHK_SYS_HANDSHAKE_PROC
	PHP
	SEI

	LDA <RAM_BUFFER
	STA HWE_CMD_BA+CMD_PARAMETER
	LDA <RAM_BUFFER+1
	STA HWE_CMD_BA+CMD_PARAMETER+1
	LDA <RAM_BUFFER+2
	STA HWE_CMD_BA+CMD_PARAMETER+2
	LDA #CMD_PLAY
	STA HWE_CMD_BA+CMD_IDX
	LDA #02H
	TSB !INTRF
	SET_SPEECH_BUSY_RT

	LDA <RAM_BUFFER+3
	STA <SIL_COUNT
	ADC_ADDR_DP EQU_ADDR,4,EQU_ADDR

	LDA #SIL_DOING
	TRB <NUSP_FLAG
	LDA #SP_DOING
	TSB <NUSP_FLAG
.IFDEF STANDBY_TIME
	LDA #EN_STANDBY
	BIT <NUSP_FLAG1
	BEQ GET_SPEECH_SENTENCE_PLAYLIST_NEXT

	LDA #ENTER_STANDBY
	TRB <NUSP_FLAG1
	CLEAR_STANDBY_RAM
GET_SPEECH_SENTENCE_PLAYLIST_NEXT:
.ENDIF
	LDA #SP_BUSY
	TSB <STATUS_FLAG
    	SP_BUSY_SPBUSY_OUT
	PLP
;JSR CHK_HANDSHAKE_PROC
	RTS
;-----------------------------------------
PLAY_CMD_PROCESS:
;index*4+PLAY_LIST_ADDR
	ASL <RAM_BUFFER 
	ROL <RAM_BUFFER+1
	ROL <RAM_BUFFER+2
	ASL <RAM_BUFFER 
	ROL <RAM_BUFFER+1
	ROL <RAM_BUFFER+2

	CLC
	LDA <RAM_BUFFER
	ADC <PLAY_LIST_ADDR
	STA <RAM_BUFFER
	LDA <RAM_BUFFER+1
	ADC <PLAY_LIST_ADDR+1
	STA <RAM_BUFFER+1
	LDA <RAM_BUFFER+2
	ADC <PLAY_LIST_ADDR+2
	STA <RAM_BUFFER+2

GET_SPEECH_TABLE_PLAYLIST:
	LDA #WDTC_CLR
	STA !WDTC	

;4B offset address
	LDA #04H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM RAM_BUFFER,ISP_LEN,RAM_BUFFER+3		
	CLC
	LDA <STARTADDR_PLAYLIST
	ADC <RAM_BUFFER+3
	STA <RAM_BUFFER+3
	LDA <STARTADDR_PLAYLIST+1
	ADC <RAM_BUFFER+4
	STA <RAM_BUFFER+4
	LDA <STARTADDR_PLAYLIST+2
	ADC <RAM_BUFFER+5
	STA <RAM_BUFFER+5

	LDA #01H
	STA <ISP_LEN
	STZ <ISP_LEN+1
	FLASH_READ_RAM RAM_BUFFER+3,ISP_LEN,RAM_BUFFER

	LDA <PLAY_TYPE
	CMP #04H
	BNE GET_SPEECH_TABLE_PLAYLIST_GO
READ_SDA_CHECK_INDEX_RCOUNT:
	LDA <RAM_BUFFER
	STA RESOURCE_COUNT
	JMP PLAY_CMD_PROCESS_INVALID

GET_SPEECH_TABLE_PLAYLIST_GO:
	LDA <RAM_BUFFER
	STA <EQU_COUNTER
	BNE GET_SPEECH_TABLE_PLAYLIST_NEXT

	LDA <PLAY_TYPE
	CMP #02H
	BEQ GET_PLAYLIST_MULTI_PLAY
	BCC PLAY_CMD_PROCESS_INVALID

	LDA #MULTI_PLAY
	BIT <NUSP_FLAG
	BNE GET_PLAYLIST_MULTI_PLAY

	LDA #PLAY_REPEAT
	BIT <NUSP_FLAG
	BNE GET_PLAYLIST_PLAY_REPEAT

PLAY_CMD_PROCESS_INVALID:
	LDA #00H
	RTS

GET_PLAYLIST_PLAY_REPEAT:
	LDA <PLAY_REPEAT_COUNT
	BEQ RELOAD_PLAYLIST_INDEX
	DEC <PLAY_REPEAT_COUNT
	BNE RELOAD_PLAYLIST_INDEX
	LDA #PLAY_REPEAT
	TRB <NUSP_FLAG
	JMP PLAY_CMD_PROCESS_INVALID	

RELOAD_PLAYLIST_INDEX:
	STZ <RAM_BUFFER+2
	LDA <PLAY_LIST_INDEX+1
	STA <RAM_BUFFER+1	;H
	LDA <PLAY_LIST_INDEX
	STA <RAM_BUFFER		;L
	JMP PLAY_CMD_PROCESS

GET_PLAYLIST_MULTI_PLAY:
	INC <MULTI_PLAY_INDEX
	LDA <MULTI_PLAY_INDEX
	CMP <MULTI_PLAY_NUMBER
	BCC GET_PLAYLIST_MULTI_PLAY_NEXT

	LDA <PLAY_TYPE
	CMP #02H
	BEQ PLAY_CMD_PROCESS_INVALID
	LDA #PLAY_REPEAT
	BIT <NUSP_FLAG
	BNE GET_PLAYLIST_MULTI_PLAY_REPEAT
	LDA #MULTI_PLAY
	TRB <NUSP_FLAG
	JMP PLAY_CMD_PROCESS_INVALID

GET_PLAYLIST_MULTI_PLAY_REPEAT:
	LDA <PLAY_REPEAT_COUNT
	BEQ RELOAD_MULTI_PLAYLIST_INDEX
	DEC <PLAY_REPEAT_COUNT
	BNE RELOAD_MULTI_PLAYLIST_INDEX
	LDA #(MULTI_PLAY+PLAY_REPEAT)
	TRB <NUSP_FLAG
	JMP PLAY_CMD_PROCESS_INVALID	

RELOAD_MULTI_PLAYLIST_INDEX:
	STZ <MULTI_PLAY_INDEX

GET_PLAYLIST_MULTI_PLAY_NEXT:
	STZ <RAM_BUFFER+2
	LDA <MULTI_PLAY_INDEX	
	ASL A
	TAX	
	LDA MULTI_PLAY_BUFFER,X
	STA <RAM_BUFFER+1	;H
	LDA MULTI_PLAY_BUFFER+1,X
	STA <RAM_BUFFER	;L
	JMP PLAY_CMD_PROCESS

GET_SPEECH_TABLE_PLAYLIST_NEXT:
	STZ <EQU_INDEX
	STZ <SIL_COUNT
	ADC_ADDR_DP	RAM_BUFFER+3,4,EQU_ADDR

	OPEN_PA
	JSR GET_SPEECH_SENTENCE_PLAYLIST
	LDA #01H
	RTS
;-----------------------------------------
;-----------------------------------------
STOP_PLAYING_PROC:
.IF (WITH_CONTINUE_PLAY .EQ. 1)
	LDA <NUSP_FLAG 
	BIT #PLAY_PAUSE
	BEQ STOP_PLAYING_NOT_CONTINUE_PLAY

	CHK_BUSY_SENTENCE
	BEQ STOP_PLAYING_NOT_CONTINUE_PLAY1
	STZ <TEMP_USED
	STOP_FOR_NST 00
STOP_PLAYING_NOT_CONTINUE_PLAY1:
	HW_CMD_DEL_PUSH_LAYER_RAM PLAY_LAYER_INDEX

STOP_PLAYING_NOT_CONTINUE_PLAY:
.ENDIF	

	CHK_BUSY_CH1
	BNE STOP_PLAYING_PROC_NEXT

	LDA <TEMP_USED
	BEQ STOP_PLAYING_PROC_WAIT_HWENG_OFF
PWR_DOWN_LOOP:
	LDY #FFH
PWR_DOWN_LOOP1:
	LDA #WDTC_CLR
	STA !WDTC
	NOP
	NOP
	NOP
	NOP
	DEY
	BNE PWR_DOWN_LOOP1	
	JMP STOP_PLAYING_PROC_WAIT_HWENG_OFF

STOP_PLAYING_PROC_NEXT:
	STOP_FOR_NST 00

STOP_PLAYING_PROC_WAIT_HWENG_OFF:
	JSR CHK_HANDSHAKE_PROC
	WAIT_HWENG_OFF
	RTS
;-----------------------------------------	
STOP_PLAY_CLEAR_RAM_PROC:
	STZ <TEMP_USED
	JSR STOP_PLAYING_PROC
	LDA #(SP_DOING+SIL_DOING+MULTI_PLAY+PLAY_REPEAT+SLEEP_AFTER)
	TRB <NUSP_FLAG
	SP_FREE_PROC
	CLEAR_CONTINUE_PLAY_RAM
	RTS
;-----------------------------------------
RESET_SLEEP_PROC:
	SEI
	CLOSE_PA
	CLEAR_STANDBY_RAM
	CLEAR_RX_RAM

	LDA #CMD_VALID
	STA <STATUS_FLAG
	SP_FREE_SPBUSY_OUT

	RESET_SCLK_SDA
	RTS
;======================================================	
NSP_EXPAN_RAM:
	LDA !SYSCFG1
	CMP #4FH
;CMP #.LOW.(SYSCFG1_ISP >>4)
	BEQ  NSP_EXPAN_RAM_END

	LDA #E3H
	STA !CFGULK
	LDA #97H
	STA !CFGULK
	LDA #A2H
	STA !CFGULK
NSP_EXPAN_RAM_CHK_CFGULK:
	LDA !CFGULK
	BIT #01H
	BEQ NSP_EXPAN_RAM_CHK_CFGULK

; shared ram allocation
	LDA #4FH
;LDA #.LOW.(SYSCFG1_ISP >>4)
	STA !SYSCFG1
	STZ !CFGULK
NSP_EXPAN_RAM_END:
	RTS
;-----------------------------------------
NSP_RELOAD_RAM:
	LDA #E3H
	STA !CFGULK
	LDA #97H
	STA !CFGULK
	LDA #A2H
	STA !CFGULK
NSP_RELOAD_RAM_CHK_CFGULK:
	LDA !CFGULK
	BIT #01H
	BEQ NSP_RELOAD_RAM_CHK_CFGULK

; shared ram allocation
	LDA #.LOW.(SHM_RAM_END >> 4)
	STA !SYSCFG1
	STZ !CFGULK
	RTS
;======================================================	
SAVE_LIB_DPD_RAM:
	LDX #FFH
SAVE_LIB_DPD_RAM_LOOP:
	INX
	LDA <NUSP_FLAG,X
	STA NUSP_FLAG_BAK,X
	CPX #(DPD_RAM_SIZE-1)
	BNE SAVE_LIB_DPD_RAM_LOOP

	INX
	LDA !BP0D
	STA NUSP_FLAG_BAK,X
	INX
	LDA !BP0EN
	STA NUSP_FLAG_BAK,X
	INX
	LDA !BP1D
	STA NUSP_FLAG_BAK,X
	INX
	LDA !BP1EN
	STA NUSP_FLAG_BAK,X
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	INX
	LDA !BP2D
	STA NUSP_FLAG_BAK,X
	INX
	LDA !BP2EN
	STA NUSP_FLAG_BAK,X
.ENDIF
	RTS
;-----------------------------------------------------	
RESTORE_LIB_DPD_RAM:
	LDX #FFH
RESTORE_LIB_DPD_RAM_LOOP:
	INX
	LDA NUSP_FLAG_BAK,X
	STA <NUSP_FLAG,X
	CPX #(DPD_RAM_SIZE-1)
	BNE RESTORE_LIB_DPD_RAM_LOOP

	INX
	LDA NUSP_FLAG_BAK,X
	STA !BP0D
	INX
	LDA NUSP_FLAG_BAK,X
	STA !BP0EN
	INX
	LDA NUSP_FLAG_BAK,X
	STA !BP1D
	INX
	LDA NUSP_FLAG_BAK,X
	STA !BP1EN
.IF (PARTNO='N589B480N').OR.(PARTNO='N589D650N').OR.(PARTNO='N589D960N')
	INX
	LDA NUSP_FLAG_BAK,X
	STA !BP2D
	INX
	LDA NUSP_FLAG_BAK,X
	STA !BP2EN
.ENDIF
	RTS
;======================================================
READ_SDA_CHECK_TABLE:
	DW MAIN_LOOP
	DW READ_SDA_CHECK_1BCMD
	DW READ_SDA_CHECK_2BCMD
	DW READ_SDA_CHECK_3BCMD
	DW READ_SDA_CHECK_4BCMD
	DW READ_SDA_CHECK_5BCMD
	DW MAIN_LOOP
	DW READ_SDA_CHECK_7BCMD
	DW READ_SDA_CHECK_8BCMD
;-----------------------------------------------------
;-----------------------------------------------------
;TWO_WIRE_CMD_TABLE_2B:
;	DW TWO_WIRE_CMD_TABLE_ERROR	;0Xh
;	DW TWO_WIRE_CMD_TABLE_2B_1	;1Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;2Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;3Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;4Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;5Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;6Xh
;	DW TWO_WIRE_CMD_TABLE_2B_7	;7Xh
;	DW TWO_WIRE_CMD_TABLE_2B_8	;8Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;9Xh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;AXh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;BXh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;CXh
;	DW TWO_WIRE_CMD_TABLE_2B_D	;DXh
;	DW TWO_WIRE_CMD_TABLE_ERROR	;EXh
;	DW TWO_WIRE_CMD_TABLE_2B_F	;FXh

;TWO_WIRE_CMD_TABLE_ERROR:
;	DW READ_SDA_NOT_VALID		;00h
;	DW READ_SDA_NOT_VALID 		;01h
;	DW READ_SDA_NOT_VALID		;02h
;	DW READ_SDA_NOT_VALID 		;03h
;	DW READ_SDA_NOT_VALID		;04h
;	DW READ_SDA_NOT_VALID 		;05h
;	DW READ_SDA_NOT_VALID		;06h
;	DW READ_SDA_NOT_VALID 		;07h
;	DW READ_SDA_NOT_VALID		;08h
;	DW READ_SDA_NOT_VALID 		;09h
;	DW READ_SDA_NOT_VALID		;0Ah
;	DW READ_SDA_NOT_VALID 		;0Bh
;	DW READ_SDA_NOT_VALID		;0Ch
;	DW READ_SDA_NOT_VALID 		;0Dh
;	DW READ_SDA_NOT_VALID		;0Eh
;	DW READ_SDA_NOT_VALID 		;0Fh

TWO_WIRE_CMD_TABLE_2B_1:
	DW READ_SDA_READ_ID		;10h
	DW READ_SDA_READ_STATUS 	;11h
	DW READ_SDA_DO_LVD_2B		;12h
	DW READ_SDA_GET_LVD		;13h
	DW READ_SDA_CHECKSUM_RIGHT	;14h
	DW READ_SDA_GET_CHECKSUM 	;15h
	DW READ_SDA_DO_CHECKSUM_2B	;16h
	DW READ_SDA_GET_FW_VERSION 	;17h
	DW READ_SDA_NOT_VALID		;18h
	DW READ_SDA_NOT_VALID		;19h
	DW READ_SDA_NOT_VALID		;1Ah
	DW READ_SDA_NOT_VALID		;1Bh
	DW READ_SDA_NOT_VALID		;1Ch
	DW READ_SDA_NOT_VALID 		;1Dh
	DW READ_SDA_NOT_VALID		;1Eh
	DW READ_SDA_NOT_VALID 		;1Fh

TWO_WIRE_CMD_TABLE_2B_7:
	DW READ_SDA_NOT_VALID		;70h
	DW READ_SDA_NOT_VALID 		;71h
	DW READ_SDA_NOT_VALID		;72h
	DW READ_SDA_NOT_VALID 		;73h
	DW READ_SDA_NOT_VALID		;74h
	DW READ_SDA_NOT_VALID 		;75h
	DW MAIN_LOOP 			;76h:READ_SDA_CHECK_INDEX_RCOUNT
	DW READ_SDA_GET_INDEX_RCOUNT 	;77h
	DW READ_SDA_PAUSE_2B		;78h
	DW READ_SDA_RESUME_2B 		;79h
	DW READ_SDA_CHECK_CMD_MULTI_PLAY			;7Ah:
	DW READ_SDA_READ_STOP_REPEAT	;7Bh
	DW MAIN_LOOP 				;7Ch:READ_SDA_REPEAT
	DW READ_SDA_CHECK_CMD_MULTI_PLAY			;7Dh: 
	DW MAIN_LOOP				;7Eh:READ_SDA_PLAY_NOT_SLEEP
	DW MAIN_LOOP				;7Fh:READ_SDA_SLEEP_AFTER_PLAY

TWO_WIRE_CMD_TABLE_2B_8:
	DW READ_SDA_STOP_EQU_2B		;80h
	DW READ_SDA_PWR_RESET_2B	;81h
	DW READ_SDA_PWR_DOWN_2B		;82h
	DW READ_SDA_AUTO_SLEEP_EN 	;83h
	DW READ_SDA_AUTO_SLEEP_DIS	;84h
	DW READ_SDA_NOT_VALID 		;85h
	DW READ_SDA_NOT_VALID		;86h
	DW READ_SDA_NOT_VALID 		;87h
	DW MAIN_LOOP			;88h:READ_SDA_SET_IO_CONFIG
	DW READ_SDA_READ_IO_TYPE 	;89h
	DW MAIN_LOOP			;8Ah:READ_SDA_SET_OUT
	DW READ_SDA_READ_GET_INOUT	;8Bh
	DW READ_SDA_NOT_VALID		;8Ch
	DW READ_SDA_NOT_VALID 		;8Dh
	DW READ_SDA_SPBZOUT_EN_2B	;8Eh
	DW READ_SDA_SPBZOUT_DIS_2B 	;8Fh

TWO_WIRE_CMD_TABLE_2B_D:
	DW MAIN_LOOP			;D0h:READ_SDA_ISP_WRITE_START
	DW READ_SDA_ISP_WRITE_END_2B	;D1h
	DW MAIN_LOOP			;D2h:READ_SDA_ISP_WRITE_PAGE
	DW MAIN_LOOP			;D3h:READ_SDA_ISP_READ_PAGE
	DW READ_SDA_ISP_CHECKSUM	;D4h
	DW MAIN_LOOP			;D5h:READ_SDA_ISP_READ_RES_INDEX
	DW READ_SDA_ISP_GET_RES_INFO	;D6h
	DW READ_SDA_ISP_WRITE_PARTIAL_START_2B ;D7h
	DW MAIN_LOOP			;D8h:READ_SDA_ISP_WRITE_PARTIAL_BAK
	DW MAIN_LOOP			;D9h:READ_SDA_ISP_WRITE_PARTIAL
	DW MAIN_LOOP			;DAh:READ_SDA_ISP_READ_PARTIAL
	DW READ_SDA_ISP_GET_USER_SPACE_INFO 	;DBh
	DW READ_SDA_NOT_VALID		;DCh
	DW READ_SDA_NOT_VALID 		;DDh
	DW READ_SDA_NOT_VALID		;DEh
	DW READ_SDA_NOT_VALID 		;DFh

TWO_WIRE_CMD_TABLE_2B_F:
	DW MAIN_LOOP			;F0h:READ_SDA_SET_VOL
	DW READ_SDA_READ_GET_VOL	;F1h
	DW READ_SDA_NOT_VALID		;F2h
	DW READ_SDA_NOT_VALID 		;F3h
	DW READ_SDA_NOT_VALID		;F4h
	DW READ_SDA_NOT_VALID 		;F5h
	DW READ_SDA_NOT_VALID		;F6h
	DW READ_SDA_NOT_VALID 		;F7h
	DW READ_SDA_NOT_VALID		;F8h
	DW READ_SDA_NOT_VALID 		;F9h
	DW READ_SDA_NOT_VALID		;FAh
	DW READ_SDA_NOT_VALID 		;FBh
	DW READ_SDA_NOT_VALID		;FCh
	DW READ_SDA_NOT_VALID 		;FDh
	DW READ_SDA_NOT_VALID		;FEh
	DW READ_SDA_NOT_VALID 		;FFh
;======================================================
LVDC_SETTNG_TABLE:
	DB 00H
	DB LVDC_V33
	DB LVDC_V30
	DB LVDC_V27
	DB LVDC_V24
	DB LVDC_V21

LVDC_VALUE_TABLE:
	DB CMD_LVD_MORE_THAN_V33
	DB CMD_LVD_V30_V33
	DB CMD_LVD_V27_V30
	DB CMD_LVD_V24_V27
	DB CMD_LVD_V21_V24
	DB CMD_LVD_LESS_THAN_V21

;set_volume:25us~6ms	
;play:1ms
;stop:12~18.5ms
;reset:2.1ms(without checksum)~2.2s(with checksum)
	ENDS
;==========================================================================
;	ASSIGN INTERRUPT VECTORS INSIDE THIS SECTION
;==========================================================================
	VECTOR: SECTION

	ORG 1080H
	DW 	FXF15_ISR		;FXF15 ISR
	DW 	FXF13_ISR		;FXF13 ISR
	DW 	FXF10_ISR		;FXF10 ISR

	ORG	1086H
	DW	LRCT_ISR		;LRCT ISR
	DW	RESERVE2_ISR
	DW	ADC_ISR			;ADC ISR
	DW	RESERVE1_ISR	

	ORG	108EH
	DW	1000H			;IV OF BRK
	DW	TMA_ISR			;TIMER A ISR
	DW 	TMG_ISR			;TIMER G ISR

	ORG	1098H
	DW	PORT_ISR		;PORT ISR

	ORG 109CH
	DW	MAIN_START		;IV OF RESET

	ENDS


;**The following is audio external**
;**The following is sentence label**
;**The following is INIT_DECODE_SPEECH label**
	EXT_PROGRAM: SECTION
	ENDS
